<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTå®Ÿç¿’ãƒãƒ¼ãƒˆ</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PTå®Ÿç¿’ãƒãƒ¼ãƒˆ">
    <link rel="apple-touch-icon" href="./icon-192.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3498db;
            --warning: #ef4444;
            --success: #1abc9c;
            --bg: #f0f4f8;
        }

        body {
            font-family: sans-serif;
            line-height: 1.4;
            padding: 10px;
            background-color: var(--bg);
            color: #333;
            font-size: 13px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        /* å›ºå®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .menu-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
        }

        .menu-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-content {
            display: none;
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 230px;
            overflow: hidden;
        }

        .menu-content button {
            width: 100%;
            padding: 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
            font-weight: bold;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
        }

        .modal-body {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 95%;
            max-width: 850px;
            max-height: 90%;
            padding: 20px;
            border-radius: 12px;
            overflow-y: auto;
        }

        .close-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }

        /* æ‚£è€…ã‚«ãƒ¼ãƒ‰ */
        .patient-block {
            border: 2px solid #cbd5e1;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            background: #fff;
            position: relative;
        }

        .row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .col {
            flex: 1;
            min-width: 120px;
        }

        label {
            font-weight: bold;
            font-size: 0.7rem;
            color: #475569;
            display: block;
            margin-bottom: 3px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }

        /* æ¤œç´¢ã¨ãƒ†ãƒ¼ãƒ–ãƒ« */
        .search-input {
            width: 100%;
            padding: 6px;
            margin-bottom: 5px;
            border: 1px solid var(--secondary);
            border-radius: 4px;
            font-size: 0.75rem;
            background: #ebf5fb;
        }

        .compare-container {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .compare-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            gap: 5px;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #fef3c7;
        }

        .paralysis-highlight {
            background-color: #fee2e2 !important;
            border: 1px solid #f87171 !important;
        }

        .list-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            max-height: 250px;
            overflow-y: auto;
        }

        .list-row {
            display: grid;
            gap: 5px;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #edf2f7;
        }

        .rehab-grid {
            grid-template-columns: 2fr 1.2fr 0.7fr 0.7fr 0.7fr 0.7fr 0.7fr;
        }

        .list-row.checked-row {
            background-color: #e8f8f5;
            border-left: 4px solid var(--success);
        }

        .list-row.hidden {
            display: none;
        }

        .list-name {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .list-name input {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }

        .vital-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr 1fr;
            gap: 6px;
        }

        .del-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
        }

        #warning-box {
            display: none;
            background: #fff5f5;
            border-left: 5px solid var(--warning);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            color: #b91c1c;
            font-weight: bold;
        }

        canvas {
            max-width: 100%;
            margin-top: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
        }

        .detail-input {
            display: none;
            margin-top: 5px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
        }

        .section-header label {
            margin-bottom: 0;
        }

        .section-reset-btn {
            background: none;
            border: 1px solid #cbd5e1;
            color: #94a3b8;
            border-radius: 4px;
            padding: 1px 6px;
            font-size: 0.6rem;
            cursor: pointer;
            line-height: 1.2;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .section-reset-btn:hover {
            background: #fee2e2;
            border-color: #f87171;
            color: #ef4444;
        }

        /* ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆ */
        .assess-modal .modal-body {
            max-width: 950px;
            width: 98%;
            max-height: 95vh;
            padding: 15px;
        }

        .assess-header {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .assess-header>div {
            flex: 1;
            min-width: 130px;
        }

        .assess-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .assess-tabs button {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .assess-tabs button.active {
            background: var(--primary);
            color: white;
        }

        .assess-tabs button:not(.active) {
            background: white;
            color: var(--primary);
        }

        .assess-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .assess-section h3 {
            font-size: 0.85rem;
            color: var(--primary);
            margin: 0 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid #cbd5e1;
        }

        .assess-section textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
            resize: vertical;
        }

        .assess-section .assess-row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .assess-section .assess-row>div {
            flex: 1;
            min-width: 150px;
        }

        .assess-section label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #475569;
            display: block;
            margin-bottom: 2px;
        }

        .problem-row {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 4px;
        }

        .problem-row span {
            font-weight: bold;
            font-size: 0.75rem;
            color: var(--primary);
            min-width: 22px;
        }

        .problem-row input {
            flex: 1;
            padding: 5px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 12px;
        }

        .assess-save-bar {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .assess-save-bar button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* ç—‡ä¾‹æ‚£è€…ãƒˆã‚°ãƒ« */
        .case-toggle {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            color: #64748b;
            cursor: pointer;
            user-select: none;
        }

        .case-toggle input {
            display: none;
        }

        .case-toggle .case-label {
            padding: 3px 8px;
            border-radius: 12px;
            border: 2px solid #94a3b8;
            background: white;
            transition: all 0.2s;
        }

        .case-toggle input:checked+.case-label {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .soap-field {
            display: none;
            margin-top: 6px;
        }

        .soap-field.visible {
            display: block;
        }

        .soap-field label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #dc2626;
        }

        .soap-field textarea {
            width: 100%;
            padding: 6px;
            border: 2px solid #fca5a5;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
            resize: vertical;
            background: #fff5f5;
        }

        .note-copy-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* æ‚£è€…æƒ…å ±ãƒãƒƒã‚¸ */
        .patient-info-badge {
            display: inline-flex;
            gap: 4px;
            margin-left: 6px;
            font-size: 0.7rem;
            vertical-align: middle;
        }

        .patient-info-badge .badge-item {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .patient-info-badge .badge-disease {
            background: #fef3c7;
            color: #92400e;
        }

        /* ç–¾æ‚£æ¤œç´¢ãƒãƒ¼ */
        .disease-search-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #ebf5fb;
            border: 1px solid var(--secondary);
            border-radius: 8px;
        }

        .disease-search-bar input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .disease-search-bar label {
            font-size: 0.8rem;
            white-space: nowrap;
            margin-bottom: 0;
        }

        /* é …ç›®è¿½åŠ ãƒ»ç·¨é›†ãƒœã‚¿ãƒ³ */
        .item-action-btns {
            display: inline-flex;
            gap: 2px;
            margin-left: 4px;
        }

        .item-action-btns button {
            background: none;
            border: 1px solid #cbd5e1;
            border-radius: 3px;
            padding: 1px 4px;
            font-size: 0.6rem;
            cursor: pointer;
            color: #64748b;
            line-height: 1;
        }

        .item-action-btns button:hover {
            background: #fee2e2;
            border-color: #f87171;
            color: #ef4444;
        }

        .add-item-btn {
            display: block;
            width: 100%;
            padding: 6px;
            margin-top: 5px;
            background: #f0fdf4;
            border: 1px dashed #86efac;
            border-radius: 6px;
            color: #16a34a;
            font-weight: bold;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-item-btn:hover {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .no-patient-msg {
            color: #94a3b8;
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
        body.dark-mode {
            --primary: #60a5fa;
            --secondary: #38bdf8;
            --warning: #f87171;
            --success: #34d399;
            --bg: #0f172a;
            color: #e2e8f0;
        }

        body.dark-mode .container {
            background: #1e293b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .patient-block {
            background: #1e293b;
            border-color: #475569;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #334155;
            color: #e2e8f0;
            border-color: #475569;
        }

        body.dark-mode .list-container {
            background: #1e293b;
            border-color: #475569;
        }

        body.dark-mode .compare-container {
            background: #1e293b;
            border-color: #475569;
        }

        body.dark-mode .compare-row {
            border-bottom-color: #475569;
        }

        body.dark-mode .search-input {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        body.dark-mode .menu-content {
            background: #1e293b;
            border-color: #475569;
        }

        body.dark-mode .menu-content button {
            border-bottom-color: #475569;
            color: #e2e8f0;
        }

        body.dark-mode .modal-body {
            background: #1e293b;
        }

        body.dark-mode .assess-section {
            background: #1e293b;
            border-color: #475569;
        }

        body.dark-mode .disease-search-bar {
            background: #1e293b;
            border-color: #475569;
        }

        body.dark-mode h1 {
            border-bottom-color: var(--primary);
        }

        body.dark-mode label {
            color: #94a3b8;
        }

        body.dark-mode .section-reset-btn {
            border-color: #475569;
            color: #64748b;
        }

        body.dark-mode .add-item-btn {
            background: #1e293b;
            border-color: #475569;
            color: #34d399;
        }

        body.dark-mode .patient-info-badge .badge-item {
            background: #312e81;
            color: #a5b4fc;
        }

        body.dark-mode .patient-info-badge .badge-disease {
            background: #451a03;
            color: #fbbf24;
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
        .dark-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ‚£è€…ãƒ–ãƒ­ãƒƒã‚¯æŠ˜ã‚ŠãŸãŸã¿ */
        .patient-block .block-content {
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }

        .patient-block.collapsed .block-content {
            max-height: 0 !important;
            opacity: 0;
            padding: 0;
        }

        .patient-block .collapse-btn {
            background: none;
            border: 1px solid #cbd5e1;
            color: #64748b;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 6px;
            transition: all 0.15s;
        }

        .patient-block.collapsed .collapse-btn {
            background: #dbeafe;
            color: var(--primary);
            border-color: var(--primary);
        }

        /* ä¼‘æ†©æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯ */
        .patient-block.break-block {
            border-color: #fbbf24;
            background: #fffbeb;
        }

        .patient-block.break-block .block-content {
            display: none;
        }

        body.dark-mode .patient-block.break-block {
            background: #1c1917;
            border-color: #92400e;
        }

        /* è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .autosave-indicator {
            position: fixed;
            bottom: 8px;
            right: 15px;
            z-index: 998;
            font-size: 0.7rem;
            color: #94a3b8;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s;
        }

        body.dark-mode .autosave-indicator {
            background: rgba(30, 41, 59, 0.9);
        }

        .autosave-indicator.saving {
            color: #f59e0b;
        }

        /* ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        .sort-btn {
            padding: 4px 10px;
            background: #e0e7ff;
            color: #3730a3;
            border: 1px solid #a5b4fc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            transition: all 0.15s;
        }

        .sort-btn:hover {
            background: #c7d2fe;
        }

        body.dark-mode .sort-btn {
            background: #312e81;
            color: #a5b4fc;
            border-color: #4338ca;
        }
    </style>
</head>

<body>

    <button class="dark-toggle" onclick="toggleDarkMode()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ™</button>

    <div class="menu-container">
        <button class="menu-btn" onclick="toggleMenu()">â‰¡</button>
        <div class="menu-content" id="nav-menu">
            <button onclick="showCriteria()">ğŸ“ ä¸­æ­¢åŸºæº–ã‚’ç¢ºèª</button>
            <button onclick="generateVerbalScript()">ğŸ“¢ å ±å‘Šç”¨ã‚«ãƒ³ãƒšç”Ÿæˆ</button>
            <button onclick="showInsHistory()">ğŸ“ å­¦ã³ãƒ»å‚™è€ƒã®å±¥æ­´</button>
            <button onclick="exportData()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
            <button onclick="importData()">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</button>
            <button onclick="showAssessmentSheet()">ğŸ“‹ ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆ</button>
            <button onclick="showProgressRecord()">ğŸ“Š çµŒéè¨˜éŒ²ï¼ˆSOAPï¼‰</button>
            <button onclick="confirmReset()" style="color:var(--warning);">âš ï¸ å…¨ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImportFile(event)">
    </div>

    <div id="chart-modal" class="modal">
        <div class="modal-body">
            <h2 id="chart-title">ğŸ“ˆ æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
            <div style="margin-bottom:10px;display:flex;gap:6px;">
                <button onclick="switchChartTab('vital')" id="tab-vital"
                    style="flex:1;padding:8px;border:2px solid var(--primary);border-radius:6px;background:var(--primary);color:white;font-weight:bold;cursor:pointer;">ğŸ©º
                    ãƒã‚¤ã‚¿ãƒ«</button>
                <button onclick="switchChartTab('score')" id="tab-score"
                    style="flex:1;padding:8px;border:2px solid var(--primary);border-radius:6px;background:white;color:var(--primary);font-weight:bold;cursor:pointer;">ğŸ“Š
                    æ¤œæŸ»çµæœ</button>
            </div>
            <div id="vital-chart-area"><canvas id="vitalChart"></canvas></div>
            <div id="score-chart-area" style="display:none;"><canvas id="scoreChart"></canvas></div>
            <button class="close-btn" onclick="closeModal('chart-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <div id="criteria-modal" class="modal">
        <div class="modal-body">
            <h2>ğŸ“ ãƒªãƒä¸­æ­¢åŸºæº–</h2>
            <p>å®‰é™æ™‚ï¼šPR 120â†‘, BP 200/120â†‘ã€‚<br>é‹å‹•ä¸­ï¼šBP 40â†‘ä¸Šæ˜‡, PR 140â†‘, Borg 17â†‘ç­‰ã§ä¸­æ­¢ã€‚</p><button class="close-btn"
                onclick="closeModal('criteria-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <div id="script-modal" class="modal">
        <div class="modal-body">
            <h2>ğŸ“¢ å ±å‘Šã‚«ãƒ³ãƒš</h2>
            <div id="script-cont" style="white-space:pre-wrap;"></div><button class="close-btn"
                onclick="closeModal('script-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <div id="ins-history-modal" class="modal">
        <div class="modal-body">
            <h2>ğŸ“ å­¦ã³ãƒ»å‚™è€ƒã®å±¥æ­´</h2>
            <div style="margin-bottom:10px;">
                <label>æ‚£è€…ã‚’é¸æŠ</label>
                <select id="ins-history-patient" onchange="loadInsHistory()"
                    style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px;font-size:13px;"></select>
            </div>
            <div id="ins-history-content" style="max-height:60vh;overflow-y:auto;"></div>
            <button class="close-btn" onclick="closeModal('ins-history-modal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="assess-modal" class="modal assess-modal">
        <div class="modal-body">
            <h2 style="margin:0 0 10px 0;color:var(--primary);">ğŸ“‹ ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆ</h2>
            <div class="assess-header">
                <div>
                    <label>æ‚£è€…</label>
                    <select id="assess-patient" onchange="loadAssessment()"
                        style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px;font-size:13px;"></select>
                </div>
                <div>
                    <label>è¨˜å…¥æ—¥</label>
                    <input type="date" id="assess-date" onchange="loadAssessmentByDate()"
                        style="width:100%;padding:7px;border:1px solid #cbd5e1;border-radius:4px;font-size:13px;">
                </div>
                <div style="flex:0;min-width:auto;">
                    <label>&nbsp;</label>
                    <button onclick="loadAssessmentDates()"
                        style="padding:7px 12px;background:var(--secondary);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ“…
                        å±¥æ­´</button>
                </div>
            </div>

            <div class="assess-tabs">
                <button id="assess-tab1" class="active" onclick="switchAssessTab('sheet1')">ğŸ“ ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ… </button>
                <button id="assess-tab2" onclick="switchAssessTab('sheet2')">ğŸ”€ ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ…¡ï¼ˆICFï¼‰</button>
            </div>

            <!-- ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ…  -->
            <div id="assess-sheet1">
                <div class="assess-section">
                    <h3>ğŸ“‹ åŸºç¤æƒ…å ±ãƒ»åŒ»å­¦çš„æƒ…å ±</h3>
                    <div class="assess-row">
                        <div style="min-width:80px;flex:0;"><label>å¹´é½¢</label><input type="text" id="as1-age"
                                placeholder="ä¾‹: 80ä»£"
                                style="padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:12px;"></div>
                        <div style="min-width:80px;flex:0;"><label>æ€§åˆ¥</label><select id="as1-sex"
                                style="padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:12px;">
                                <option value="">-</option>
                                <option value="ç”·æ€§">ç”·æ€§</option>
                                <option value="å¥³æ€§">å¥³æ€§</option>
                            </select></div>
                        <div><label>è¨ºæ–­å</label><input type="text" id="as1-diagnosis"
                                style="padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:12px;"></div>
                    </div>
                    <div class="assess-row">
                        <div><label>åˆä½µç—‡</label><textarea id="as1-comorbidity" rows="2"></textarea></div>
                        <div><label>æ—¢å¾€æ­´</label><textarea id="as1-pastHistory" rows="2"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>ç¾ç—…æ­´</label><textarea id="as1-currentHistory" rows="3"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>æœè–¬çŠ¶æ³</label><textarea id="as1-medication" rows="2"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>å®‰é™åº¦ãƒ»ãã®ä»–ã®ç‰¹è¨˜äº‹é …</label><textarea id="as1-restrictions" rows="2"></textarea></div>
                    </div>
                </div>

                <div class="assess-section">
                    <h3>ğŸ‘¥ ç¤¾ä¼šçš„èƒŒæ™¯ãƒ»ç”Ÿæ´»æƒ…å ±</h3>
                    <div class="assess-row">
                        <div><label>å®¶æ—æ§‹æˆ</label><textarea id="as1-family" rows="2"></textarea></div>
                        <div><label>ä½ç’°å¢ƒ</label><textarea id="as1-livingEnv" rows="2"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>å…¥é™¢å‰ã®ç”Ÿæ´»ï¼ˆé£²é…’ãƒ»ã‚¿ãƒã‚³ãƒ»ä»‹è­·åº¦ãƒ»ç§»å‹•èƒ½åŠ›ãƒ»å®¶äº‹ãªã©ï¼‰</label><textarea id="as1-preLife" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="assess-row">
                        <div><label>ç—…æ£Ÿï¼ˆç¾åœ¨ï¼‰ã®ç”Ÿæ´»</label><textarea id="as1-wardLife" rows="3"></textarea></div>
                    </div>
                </div>

                <div class="assess-section">
                    <h3>ğŸƒ åŸºæœ¬å‹•ä½œãƒ»ç—…æ£ŸADL</h3>
                    <div class="assess-row">
                        <div><label>ã€åŸºæœ¬å‹•ä½œã€‘ï¼ˆå¯è¿”ã‚Šãƒ»èµ·ãä¸ŠãŒã‚Šãƒ»ç«¯åº§ä½ãƒ»èµ·ç«‹ãƒ»ç§»ä¹—ãƒ»æ­©è¡Œï¼‰</label><textarea id="as1-basicMovement" rows="3"
                                placeholder="å¯è¿”ã‚Š: 
èµ·ãä¸ŠãŒã‚Š: 
ç«¯åº§ä½: 
èµ·ç«‹: 
ç§»ä¹—: 
æ­©è¡Œ: "></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>ã€ç—…æ£ŸADLã€‘ï¼ˆé£Ÿäº‹ãƒ»æ•´å®¹ãƒ»æ›´è¡£ãƒ»æ’æ³„ãƒ»å…¥æµ´ï¼‰</label><textarea id="as1-adl" rows="3" placeholder="é£Ÿäº‹: 
æ•´å®¹: 
æ›´è¡£: 
æ’æ³„: 
å…¥æµ´: "></textarea></div>
                    </div>
                </div>

                <div class="assess-section">
                    <h3>ï¿½ ä¸»è¨´</h3>
                    <textarea id="as1-chiefComplaint" rows="2"></textarea>
                </div>

                <div class="assess-section">
                    <h3>ğŸ ä»‹å…¥æ–¹é‡ãƒ»è¨ˆç”»ãƒ»ç›®æ¨™</h3>
                    <div class="assess-row">
                        <div><label>ä»–è·ç¨®ã®ä»‹å…¥æ–¹é‡ãƒ»ç›®æ¨™</label><textarea id="as1-otherProfPlan" rows="3"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>æ–¹æ³•ãªã©</label><textarea id="as1-methods" rows="2"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>ç–¾æ‚£ã‚„éšœå®³ã®äºˆå¾Œäºˆæ¸¬</label><textarea id="as1-prognosis" rows="3"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>çŸ­æœŸç›®æ¨™</label><textarea id="as1-stg" rows="3"></textarea></div>
                        <div><label>é•·æœŸç›®æ¨™</label><textarea id="as1-ltg" rows="3"></textarea></div>
                    </div>
                    <div class="assess-row">
                        <div><label>æ²»ç™‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ </label><textarea id="as1-treatment" rows="4"></textarea></div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ…¡ï¼ˆICFï¼‰ -->
            <div id="assess-sheet2" style="display:none;">
                <div class="assess-section">
                    <h3>ğŸ©º å¥åº·çŠ¶æ…‹</h3>
                    <textarea id="as2-healthCondition" rows="3" placeholder="è¨ºæ–­åã€ç™ºç—‡æ—¥ã€çµŒéç­‰"></textarea>
                </div>

                <div class="assess-section">
                    <h3>ğŸ§  å¿ƒèº«æ©Ÿèƒ½ãƒ»èº«ä½“æ§‹é€ </h3>
                    <textarea id="as2-bodyFunction" rows="4" placeholder="ç­‹åŠ›ä½ä¸‹ã€ROMåˆ¶é™ã€ç–¼ç—›ã€æ„Ÿè¦šéšœå®³ã€é«˜æ¬¡è„³æ©Ÿèƒ½éšœå®³ç­‰"></textarea>
                </div>

                <div class="assess-section">
                    <h3>ğŸƒ æ´»å‹•</h3>
                    <div class="assess-row">
                        <div><label>ã§ãã‚‹æ´»å‹•ï¼ˆèƒ½åŠ›ï¼‰</label><textarea id="as2-activityCan" rows="3"
                                placeholder="æ¤œæŸ»ãƒ»è©•ä¾¡å ´é¢ã§ç¢ºèªã•ã‚ŒãŸèƒ½åŠ›"></textarea></div>
                        <div><label>ã—ã¦ã„ã‚‹æ´»å‹•ï¼ˆå®Ÿè¡ŒçŠ¶æ³ï¼‰</label><textarea id="as2-activityDo" rows="3"
                                placeholder="ç—…æ£Ÿãƒ»æ—¥å¸¸ç”Ÿæ´»ã§ã®å®Ÿéš›ã®çŠ¶æ³"></textarea></div>
                    </div>
                </div>

                <div class="assess-section">
                    <h3>ğŸ¤ å‚åŠ </h3>
                    <textarea id="as2-participation" rows="3" placeholder="å®¶åº­å†…å½¹å‰²ã€ç¤¾ä¼šå‚åŠ ã€å°±åŠ´ãƒ»å°±å­¦ç­‰"></textarea>
                </div>

                <div class="assess-section">
                    <h3>ğŸŒ ç’°å¢ƒå› å­</h3>
                    <div class="assess-row">
                        <div><label>ä¿ƒé€²å› å­ï¼ˆï¼‹ï¼‰</label><textarea id="as2-envPositive" rows="3"
                                placeholder="å®¶æ—ã®ã‚µãƒãƒ¼ãƒˆã€ç¦ç¥‰ç”¨å…·ã€ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼ç­‰"></textarea></div>
                        <div><label>é˜»å®³å› å­ï¼ˆï¼ï¼‰</label><textarea id="as2-envNegative" rows="3"
                                placeholder="æ®µå·®ã€ç‹¬å±…ã€çµŒæ¸ˆçš„å•é¡Œç­‰"></textarea></div>
                    </div>
                </div>

                <div class="assess-section">
                    <h3>ğŸ‘¤ å€‹äººå› å­</h3>
                    <textarea id="as2-personalFactor" rows="3" placeholder="æ€§æ ¼ã€ä¾¡å€¤è¦³ã€ç”Ÿæ´»æ­´ã€ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ç­‰"></textarea>
                </div>

                <div class="assess-section">
                    <h3>ğŸ”— çµ±åˆã¨è§£é‡ˆ</h3>
                    <textarea id="as2-integration" rows="5" placeholder="ICFå„é …ç›®ã®é–¢é€£æ€§ã¨å…¨ä½“çš„ãªè§£é‡ˆ"></textarea>
                </div>
            </div>

            <div class="assess-save-bar">
                <button onclick="saveAssessment()" style="background:var(--primary);color:white;">ğŸ’¾ ä¿å­˜</button>
                <button onclick="generateAssessmentNote()" style="background:var(--success);color:white;">ğŸ“
                    ãƒãƒ¼ãƒˆå‡ºåŠ›</button>
                <button onclick="closeModal('assess-modal')" style="background:#64748b;color:white;">é–‰ã˜ã‚‹</button>
            </div>
            <div id="assess-output"
                style="display:none; background:#1e293b; color:#f8fafc; padding:15px; border-radius:8px; margin-top:12px; white-space:pre-wrap; font-family:monospace; font-size:0.8rem;">
            </div>
        </div>
    </div>

    <!-- çµŒéè¨˜éŒ²ï¼ˆSOAPï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="soap-modal" class="modal assess-modal">
        <div class="modal-body">
            <h2 style="margin:0 0 10px 0;color:var(--primary);">ğŸ“Š çµŒéè¨˜éŒ²ï¼ˆSOAPï¼‰</h2>
            <div class="assess-header">
                <div>
                    <label>æ‚£è€…</label>
                    <select id="soap-patient" onchange="onSOAPPatientChange()"
                        style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:4px;font-size:13px;"></select>
                </div>
                <div style="flex:0;min-width:auto;display:flex;gap:6px;align-items:flex-end;">
                    <button id="soap-new-btn" onclick="showSOAPInput()"
                        style="padding:8px 14px;background:#dc2626;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:bold;white-space:nowrap;">âœï¸
                        æ–°è¦å…¥åŠ›</button>
                    <button onclick="closeModal('soap-modal')"
                        style="padding:8px 14px;background:#64748b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:bold;">é–‰ã˜ã‚‹</button>
                </div>
            </div>

            <!-- ä¸€è¦§è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
            <div id="soap-list-view">
                <div id="soap-history-list" style="margin-top:10px;">
                    <p style="color:#94a3b8;text-align:center;padding:30px 0;">æ‚£è€…ã‚’é¸æŠã™ã‚‹ã¨è¨˜éŒ²ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
                <button id="soap-export-all-btn" onclick="exportAllSOAP()"
                    style="display:none;margin-top:8px;padding:10px;width:100%;background:var(--success);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:0.9rem;">ğŸ“„
                    å…¨è¨˜éŒ²ã‚’å‡ºåŠ›ï¼†ã‚³ãƒ”ãƒ¼</button>
                <div id="soap-all-output"
                    style="display:none; background:#1e293b; color:#f8fafc; padding:15px; border-radius:8px; margin-top:8px; white-space:pre-wrap; font-family:monospace; font-size:0.8rem;">
                </div>
            </div>

            <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
            <div id="soap-input-view" style="display:none;">
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                    <button onclick="showSOAPList()"
                        style="padding:6px 12px;background:#94a3b8;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;">â†
                        ä¸€è¦§ã«æˆ»ã‚‹</button>
                    <label style="font-weight:bold;">è¨˜å…¥æ—¥</label>
                    <input type="date" id="soap-date"
                        style="padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:13px;">
                </div>
                <div class="assess-section" style="border-left:4px solid #3b82f6;">
                    <h3>ğŸ—£ï¸ Sï¼ˆä¸»è¦³çš„æƒ…å ±ï¼‰</h3>
                    <textarea id="soap-s" rows="4" placeholder="æ‚£è€…ã®è¨´ãˆã€å¸Œæœ›ã€æ„Ÿæƒ³ãªã©"></textarea>
                </div>
                <div class="assess-section" style="border-left:4px solid #10b981;">
                    <h3>ğŸ“ Oï¼ˆå®¢è¦³çš„æƒ…å ±ï¼‰</h3>
                    <textarea id="soap-o" rows="5" placeholder="ãƒã‚¤ã‚¿ãƒ«ã€æ¤œæŸ»çµæœã€è¦³å¯Ÿæ‰€è¦‹ãªã©"></textarea>
                </div>
                <div class="assess-section" style="border-left:4px solid #f59e0b;">
                    <h3>ğŸ§  Aï¼ˆã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆï¼‰</h3>
                    <textarea id="soap-a" rows="5" placeholder="å•é¡Œç‚¹ã®åˆ†æã€è€ƒå¯Ÿã€è§£é‡ˆãªã©"></textarea>
                </div>
                <div class="assess-section" style="border-left:4px solid #8b5cf6;">
                    <h3>ğŸ Pï¼ˆè¨ˆç”»ï¼‰</h3>
                    <textarea id="soap-p" rows="4" placeholder="ä»Šå¾Œã®æ²»ç™‚è¨ˆç”»ã€ç›®æ¨™ãªã©"></textarea>
                </div>
                <div class="assess-save-bar">
                    <button onclick="saveSOAP()" style="background:var(--primary);color:white;">ğŸ’¾ ä¿å­˜</button>
                    <button onclick="generateSOAPNote()" style="background:var(--success);color:white;">ğŸ“
                        ãƒãƒ¼ãƒˆå‡ºåŠ›</button>
                    <button onclick="showSOAPList()" style="background:#64748b;color:white;">ä¸€è¦§ã«æˆ»ã‚‹</button>
                </div>
                <div id="soap-output"
                    style="display:none; background:#1e293b; color:#f8fafc; padding:15px; border-radius:8px; margin-top:12px; white-space:pre-wrap; font-family:monospace; font-size:0.8rem;">
                </div>
            </div>
        </div>
    </div>

    <div id="data-status-bar"
        style="display:none; position:fixed; bottom:0; left:0; right:0; padding:10px 15px; font-size:0.8rem; z-index:999; text-align:center; transition:opacity 0.5s;">
    </div>
    <div class="autosave-indicator" id="autosave-indicator">ğŸ’¾ è‡ªå‹•ä¿å­˜: å¾…æ©Ÿä¸­
    </div>

    <div class="container">
        <h1>PTå®Ÿç¿’ãƒãƒ¼ãƒˆï¼šç©¶æ¥µã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‰ˆ</h1>
        <div id="warning-box"></div>
        <div style="margin-bottom: 15px;"><label>å®Ÿç¿’æ—¥</label><input type="date" id="dateInput"></div>

        <div class="disease-search-bar">
            <label>ğŸ” ç–¾æ‚£ã§æ¤œç´¢:</label>
            <select id="diseaseSearchInput" onchange="filterPatientsByDisease()"
                style="flex:1;padding:6px 10px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.8rem;">
                <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
            </select>
            <button class="sort-btn" onclick="sortPatientsByName()" title="åå‰é †ã«ä¸¦ã¹æ›¿ãˆ">â†• åå‰é †</button>
            <button class="sort-btn" onclick="sortPatientsByDisease()" title="ç–¾æ‚£åé †ã«ä¸¦ã¹æ›¿ãˆ">â†• ç–¾æ‚£åé †</button>
        </div>

        <div id="patientList"></div>

        <button onclick="addPatientBlock()"
            style="background:#64748b; color:white; border:none; padding:12px; width:100%; border-radius:8px; cursor:pointer; margin-bottom:20px; font-weight:bold;">ï¼‹
            æ‚£è€…ã‚’è¿½åŠ </button>
        <button onclick="generateNote()"
            style="background:var(--primary); color:white; border:none; padding:15px; width:100%; border-radius:8px; cursor:pointer; font-size:1.1rem; font-weight:bold;">ãƒãƒ¼ãƒˆç”Ÿæˆ
            ï¼† å…¨é …ç›®ã‚’è¨˜æ†¶</button>
        <button onclick="clearAllInputs()"
            style="background:#f59e0b; color:white; border:none; padding:12px; width:100%; border-radius:8px; cursor:pointer; font-size:0.95rem; font-weight:bold; margin-top:8px;">ğŸ—‘ï¸
            ã™ã¹ã¦ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>

        <div id="output"
            style="display:none; background:#1e293b; color:#f8fafc; padding:15px; border-radius:8px; margin-top:20px; white-space:pre-wrap; font-family:monospace; font-size:0.85rem;">
        </div>
        <button id="copy-note-btn" class="note-copy-btn" style="display:none;" onclick="copyNoteBody()">ğŸ“‹
            ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–ï¼‰</button>

        <div style="margin-top: 30px; padding: 15px; background: #e2e8f0; border-radius: 8px;">
            <label>âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼è¨­å®šï¼ˆè‡ªå‹•ä¿å­˜ï¼‰</label>
            <div class="row">
                <div class="col"><label>ç–¾æ‚£ãƒªã‚¹ãƒˆ</label><textarea id="masterDiseases" rows="4"
                        oninput="saveConfig()">å¤§è…¿éª¨è»¢å­éƒ¨éª¨æŠ˜&#13;è„³æ¢—å¡&#13;è‚ºç‚å¾Œå»ƒç”¨ç—‡å€™ç¾¤&#13;è„ŠæŸ±ç®¡ç‹­çª„ç—‡</textarea></div>
                <div class="col"><label>ãƒªãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼</label><textarea id="masterRehabs" rows="4"
                        oninput="saveConfig()">ä¸‹è‚¢ãƒªãƒ©ã‚¯ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³&#13;ãŠå°»ä¸Šã’&#13;æ­©è¡Œè¨“ç·´&#13;èµ·ç«‹è¨“ç·´&#13;ç«¯åä½ä¿æŒ</textarea></div>
                <div class="col"><label>è©•ä¾¡é …ç›® (åç§°:å˜ä½)</label><textarea id="masterCompare" rows="4"
                        oninput="saveConfig()">MMT(è…¸è…°ç­‹):æ®µéš&#13;ROM(è‚¡å±ˆæ›²):Â°&#13;BBS:ç‚¹&#13;TUG:ç§’</textarea></div>
            </div>
        </div>
    </div>

    <script>
        const DB_PREFIX = 'pt_final_v34_';
        const alphabet = (() => { const a = []; const L = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""); L.forEach(c => a.push(c)); L.forEach(c => a.push("A" + c)); L.forEach(c => a.push("B" + c)); return a; })();
        let vitalChartInstance = null; let scoreChartInstance = null;

        function toggleMenu() { const m = document.getElementById('nav-menu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showCriteria() { document.getElementById('criteria-modal').style.display = 'block'; }
        function confirmReset() { if (confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        function saveConfig() {
            localStorage.setItem(DB_PREFIX + 'config', JSON.stringify({ diseases: document.getElementById('masterDiseases').value, rehabs: document.getElementById('masterRehabs').value, compare: document.getElementById('masterCompare').value }));
            syncMasterToBlocks();
            updateDiseaseSearchOptions();
        }
        function loadConfig() { const c = JSON.parse(localStorage.getItem(DB_PREFIX + 'config')); if (c) { document.getElementById('masterDiseases').value = c.diseases; document.getElementById('masterRehabs').value = c.rehabs; document.getElementById('masterCompare').value = c.compare; } }

        function syncMasterToBlocks() {
            const diseases = document.getElementById('masterDiseases').value.split('\n').filter(v => v);
            const rehabs = document.getElementById('masterRehabs').value.split('\n').filter(v => v);
            const compares = document.getElementById('masterCompare').value.split('\n').filter(v => v);

            document.querySelectorAll('.patient-block').forEach(b => {
                // === ç–¾æ‚£ãƒªã‚¹ãƒˆã®åŒæœŸ ===
                const disEl = b.querySelector('.p-disease');
                const curDis = disEl.value;
                const curDisSide = b.querySelector('.p-dis-side').value;
                disEl.innerHTML = '<option value="">é¸æŠ</option>' + diseases.map(d => `<option value="${d}">${d}</option>`).join('');
                // ä»¥å‰ã®é¸æŠå€¤ãŒã‚ã‚Œã°å¾©å…ƒï¼ˆãƒã‚¹ã‚¿ãƒ¼ã«ç„¡ãã¦ã‚‚è¿½åŠ ï¼‰
                if (curDis) {
                    if (![...disEl.options].some(o => o.value === curDis)) {
                        const opt = document.createElement('option'); opt.value = curDis; opt.textContent = curDis; disEl.appendChild(opt);
                    }
                    disEl.value = curDis;
                }
                b.querySelector('.p-dis-side').value = curDisSide;

                // === ãƒªãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åŒæœŸ ===
                const rehabBody = b.querySelector('.rehab-list-body');
                // ç¾åœ¨ã®å…¥åŠ›çŠ¶æ…‹ã‚’ä¿å­˜
                const rehabState = {};
                rehabBody.querySelectorAll('.list-row').forEach(row => {
                    const chk = row.querySelector('.r-chk');
                    rehabState[chk.value] = {
                        checked: chk.checked,
                        min: row.querySelector('.r-min').value,
                        sec: row.querySelector('.r-sec').value,
                        c: row.querySelector('.r-c').value,
                        s: row.querySelector('.r-s').value,
                        m: row.querySelector('.r-m') ? row.querySelector('.r-m').value : '',
                        nrs: row.querySelector('.r-nrs').value,
                        bg: row.querySelector('.r-bg').value
                    };
                });
                // å†æ§‹ç¯‰
                rehabBody.innerHTML = rehabs.map(r => `<div class="list-row rehab-grid"><label class="list-name"><input type="checkbox" class="r-chk" value="${r}" onchange="sortR(this)">${r}</label><div style="display:flex;gap:2px;align-items:center;"><input type="text" class="r-min" style="width:28px;padding:4px;font-size:12px;" placeholder="åˆ†">:<input type="text" class="r-sec" style="width:28px;padding:4px;font-size:12px;" placeholder="ç§’"></div><select class="r-c">${Array.from({ length: 61 }, (_, i) => `<option value="${i}">${i}å›</option>`).join('')}</select><select class="r-s">${Array.from({ length: 11 }, (_, i) => `<option value="${i}">${i}set</option>`).join('')}</select><div style="display:flex;gap:2px;align-items:center;"><input type="text" class="r-m" style="width:36px;padding:4px;font-size:12px;" placeholder="m"><span style="font-size:11px;">m</span></div><select class="r-nrs"><option value="">-NRS</option>${Array.from({ length: 11 }, (_, i) => `<option value="${i}">${i}</option>`).join('')}</select><select class="r-bg"><option value="">-Borg</option>${[6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20].map(v => `<option value="${v}">${v}</option>`).join('')}</select></div>`).join('');
                // ä¿å­˜ã—ãŸå…¥åŠ›çŠ¶æ…‹ã‚’å¾©å…ƒ
                rehabBody.querySelectorAll('.list-row').forEach(row => {
                    const chk = row.querySelector('.r-chk');
                    const st = rehabState[chk.value];
                    if (st) {
                        chk.checked = st.checked;
                        if (st.checked) row.classList.add('checked-row');
                        row.querySelector('.r-min').value = st.min;
                        row.querySelector('.r-sec').value = st.sec;
                        row.querySelector('.r-c').value = st.c;
                        row.querySelector('.r-s').value = st.s;
                        if (row.querySelector('.r-m')) row.querySelector('.r-m').value = st.m || '';
                        row.querySelector('.r-nrs').value = st.nrs;
                        row.querySelector('.r-bg').value = st.bg;
                    }
                });
                // ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã‚’ä¸Šã«ä¸¦ã¹æ›¿ãˆ
                const rRows = Array.from(rehabBody.children);
                rRows.sort((x, y) => (x.querySelector('input').checked === y.querySelector('input').checked) ? 0 : x.querySelector('input').checked ? -1 : 1);
                rRows.forEach(r => rehabBody.appendChild(r));

                // === è©•ä¾¡é …ç›®ã®åŒæœŸ ===
                const compBody = b.querySelector('.compare-body');
                // ç¾åœ¨ã®å…¥åŠ›çŠ¶æ…‹ã‚’ä¿å­˜
                const compState = {};
                compBody.querySelectorAll('.compare-row').forEach(row => {
                    const chk = row.querySelector('.c-chk');
                    if (!chk) return;
                    compState[chk.value] = {
                        checked: chk.checked,
                        side: row.querySelector('.c-side') ? row.querySelector('.c-side').value : 'lr',
                        r: row.querySelector('.c-r') ? row.querySelector('.c-r').value : '',
                        l: row.querySelector('.c-l') ? row.querySelector('.c-l').value : '',
                        val: row.querySelector('.c-val') ? row.querySelector('.c-val').value : ''
                    };
                });
                // å†æ§‹ç¯‰
                const sideVal = b.querySelector('.p-side').value;
                compBody.innerHTML = `<div class="compare-row" style="background:#fef3c7; font-weight:bold;"><div>é …ç›®</div><div>å´</div><div>å³</div><div>å·¦</div><div>å˜ä½</div></div>` +
                    compares.map(item => {
                        const [n, u] = item.split(':');
                        return `<div class="compare-row"><div><input type="checkbox" class="c-chk" value="${n}" data-unit="${u || ''}"> ${n}</div><select class="c-side" onchange="toggleCompSide(this)" style="font-size:11px;padding:4px;"><option value="lr">å·¦å³</option><option value="l">å·¦ã®ã¿</option><option value="r">å³ã®ã¿</option><option value="none">ãªã—</option></select><input type="text" class="c-r in-r" style="grid-column:3"><input type="text" class="c-l in-l" style="grid-column:4"><input type="text" class="c-val" style="display:none;grid-column:3/5"><div style="grid-column:5">${u || ''}</div></div>`;
                    }).join('');
                // ä¿å­˜ã—ãŸå…¥åŠ›çŠ¶æ…‹ã‚’å¾©å…ƒ
                compBody.querySelectorAll('.compare-row').forEach(row => {
                    const chk = row.querySelector('.c-chk');
                    if (!chk) return;
                    const st = compState[chk.value];
                    if (st) {
                        chk.checked = st.checked;
                        const sideEl = row.querySelector('.c-side');
                        if (sideEl) { sideEl.value = st.side; toggleCompSide(sideEl); }
                        if (st.side === 'none') {
                            if (row.querySelector('.c-val')) row.querySelector('.c-val').value = st.val || st.l || '';
                        } else {
                            if (row.querySelector('.c-r')) row.querySelector('.c-r').value = st.r;
                            if (row.querySelector('.c-l')) row.querySelector('.c-l').value = st.l;
                        }
                    }
                });
                // éº»ç—ºå´ãƒã‚¤ãƒ©ã‚¤ãƒˆå†é©ç”¨
                highlight(b.querySelector('.p-side'));
            });
        }

        function filterList(input, cls) { const q = input.value.toLowerCase(); input.closest('.patient-block').querySelectorAll(`.${cls} .list-row`).forEach(r => r.classList.toggle('hidden', !r.textContent.toLowerCase().includes(q))); }

        // === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ===
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem(DB_PREFIX + 'darkMode', isDark ? '1' : '0');
            document.querySelector('.dark-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // === æ‚£è€…ãƒ–ãƒ­ãƒƒã‚¯æŠ˜ã‚ŠãŸãŸã¿ ===
        function toggleCollapse(btn) {
            const block = btn.closest('.patient-block');
            block.classList.toggle('collapsed');
            btn.textContent = block.classList.contains('collapsed') ? 'â–¼ å±•é–‹' : 'â–² ãŸãŸã‚€';
        }

        // === æ‚£è€…ãƒ–ãƒ­ãƒƒã‚¯ã‚’åå‰é †ã«ä¸¦ã¹æ›¿ãˆ ===
        function sortPatientsByName() {
            const list = document.getElementById('patientList');
            const blocks = Array.from(list.querySelectorAll('.patient-block'));
            blocks.sort((a, b) => {
                const na = a.querySelector('.p-name').value;
                const nb = b.querySelector('.p-name').value;
                return na.localeCompare(nb, 'ja');
            });
            blocks.forEach(b => list.appendChild(b));
        }

        // === æ‚£è€…ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç–¾æ‚£åé †ã«ä¸¦ã¹æ›¿ãˆ ===
        function sortPatientsByDisease() {
            const list = document.getElementById('patientList');
            const blocks = Array.from(list.querySelectorAll('.patient-block'));
            blocks.sort((a, b) => {
                const da = a.querySelector('.p-disease').value || 'ã‚“';
                const db = b.querySelector('.p-disease').value || 'ã‚“';
                return da.localeCompare(db, 'ja');
            });
            blocks.forEach(b => list.appendChild(b));
        }

        // === è‡ªå‹•ä¿å­˜ ===
        let autoSaveTimer = null;
        function startAutoSave() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            autoSaveTimer = setInterval(() => {
                autoSaveDraft();
            }, 60000); // 60ç§’ã”ã¨
        }
        function autoSaveDraft() {
            const ind = document.getElementById('autosave-indicator');
            ind.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
            ind.classList.add('saving');
            try {
                const draft = [];
                document.querySelectorAll('.patient-block').forEach(b => {
                    const name = b.querySelector('.p-name').value;
                    if (name === 'ä¼‘æ†©æ™‚é–“') {
                        draft.push({ isBreak: true, h: b.querySelector('.p-h').value, m: b.querySelector('.p-m').value });
                        return;
                    }
                    const data = {
                        name, h: b.querySelector('.p-h').value, m: b.querySelector('.p-m').value,
                        age: b.querySelector('.p-age').value, sex: b.querySelector('.p-sex').value,
                        side: b.querySelector('.p-side').value, disease: b.querySelector('.p-disease').value,
                        disSide: b.querySelector('.p-dis-side').value,
                        vPreS: b.querySelector('.v-pre-s').value, vPreD: b.querySelector('.v-pre-d').value,
                        vPrePr: b.querySelector('.v-pre-pr').value, vPreBt: b.querySelector('.v-pre-bt').value,
                        vPreSp: b.querySelector('.v-pre-sp').value,
                        vPostS: b.querySelector('.v-post-s').value, vPostD: b.querySelector('.v-post-d').value,
                        vPostPr: b.querySelector('.v-post-pr').value, vPostBt: b.querySelector('.v-post-bt').value,
                        vPostSp: b.querySelector('.v-post-sp').value,
                        soapS: b.querySelector('.p-soap-s').value,
                        ins: b.querySelector('.p-ins').value,
                        rem: b.querySelector('.p-rem').value,
                        soapP: b.querySelector('.p-soap-p').value,
                        collapsed: b.classList.contains('collapsed')
                    };
                    draft.push(data);
                });
                localStorage.setItem(DB_PREFIX + 'autosave_draft', JSON.stringify({
                    date: document.getElementById('dateInput').value,
                    blocks: draft,
                    savedAt: new Date().toLocaleTimeString('ja-JP')
                }));
                const now = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                ind.textContent = `ğŸ’¾ æœ€çµ‚ä¿å­˜: ${now}`;
            } catch (e) {
                ind.textContent = 'âš ï¸ ä¿å­˜å¤±æ•—';
            }
            setTimeout(() => ind.classList.remove('saving'), 1000);
        }
        function loadAutoSaveDraft() {
            const raw = localStorage.getItem(DB_PREFIX + 'autosave_draft');
            if (!raw) return false;
            const draft = JSON.parse(raw);
            if (!draft.blocks || !draft.blocks.length) return false;
            if (!confirm(`è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ï¼ˆ${draft.savedAt}ï¼‰ã€‚å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ`)) return false;
            if (draft.date) document.getElementById('dateInput').value = draft.date;
            // æ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('patientList').innerHTML = '';
            draft.blocks.forEach(d => {
                addPatientBlock();
                const b = document.getElementById('patientList').lastElementChild;
                if (d.isBreak) {
                    b.querySelector('.p-name').value = 'ä¼‘æ†©æ™‚é–“';
                    b.classList.add('break-block');
                    b.querySelector('.p-h').value = d.h || '1';
                    b.querySelector('.p-m').value = d.m || '00';
                    return;
                }
                b.querySelector('.p-name').value = d.name;
                b.querySelector('.p-h').value = d.h || '1';
                b.querySelector('.p-m').value = d.m || '00';
                b.querySelector('.p-age').value = d.age || '10ä»£';
                b.querySelector('.p-sex').value = d.sex || '';
                b.querySelector('.p-side').value = d.side || '';
                b.querySelector('.p-disease').value = d.disease || '';
                b.querySelector('.p-dis-side').value = d.disSide || '';
                if (d.vPreS) b.querySelector('.v-pre-s').value = d.vPreS;
                if (d.vPreD) b.querySelector('.v-pre-d').value = d.vPreD;
                if (d.vPrePr) b.querySelector('.v-pre-pr').value = d.vPrePr;
                if (d.vPreBt) b.querySelector('.v-pre-bt').value = d.vPreBt;
                if (d.vPreSp) b.querySelector('.v-pre-sp').value = d.vPreSp;
                if (d.vPostS) b.querySelector('.v-post-s').value = d.vPostS;
                if (d.vPostD) b.querySelector('.v-post-d').value = d.vPostD;
                if (d.vPostPr) b.querySelector('.v-post-pr').value = d.vPostPr;
                if (d.vPostBt) b.querySelector('.v-post-bt').value = d.vPostBt;
                if (d.vPostSp) b.querySelector('.v-post-sp').value = d.vPostSp;
                if (d.soapS) b.querySelector('.p-soap-s').value = d.soapS;
                if (d.ins) b.querySelector('.p-ins').value = d.ins;
                if (d.rem) b.querySelector('.p-rem').value = d.rem;
                if (d.soapP) b.querySelector('.p-soap-p').value = d.soapP;
                if (d.collapsed) { b.classList.add('collapsed'); const cb = b.querySelector('.collapse-btn'); if (cb) cb.textContent = 'â–¼ å±•é–‹'; }
                highlight(b.querySelector('.p-side'));
                updateInfoBadge(b.querySelector('.p-name'));
            });
            return true;
        }

        // === ãƒªãƒé …ç›®è¡ŒHTMLç”Ÿæˆ ===
        function buildRehabRowHtml(name) {
            return `<div class="list-row rehab-grid"><label class="list-name"><input type="checkbox" class="r-chk" value="${name}" onchange="sortR(this)">${name}<span class="item-action-btns"><button onclick="editRehabItem(this)" title="åå‰å¤‰æ›´">âœ</button><button onclick="deleteRehabItem(this)" title="å‰Šé™¤">âœ•</button></span></label><div style="display:flex;gap:2px;align-items:center;"><input type="text" class="r-min" style="width:28px;padding:4px;font-size:12px;" placeholder="åˆ†">:<input type="text" class="r-sec" style="width:28px;padding:4px;font-size:12px;" placeholder="ç§’"></div><select class="r-c">${Array.from({ length: 61 }, (_, i) => `<option value="${i}">${i}å›</option>`).join('')}</select><select class="r-s">${Array.from({ length: 11 }, (_, i) => `<option value="${i}">${i}set</option>`).join('')}</select><div style="display:flex;gap:2px;align-items:center;"><input type="text" class="r-m" style="width:36px;padding:4px;font-size:12px;" placeholder="m"><span style="font-size:11px;">m</span></div><select class="r-nrs"><option value="">-NRS</option>${Array.from({ length: 11 }, (_, i) => `<option value="${i}">${i}</option>`).join('')}</select><select class="r-bg"><option value="">-Borg</option>${[6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20].map(v => `<option value="${v}">${v}</option>`).join('')}</select></div>`;
        }

        // === æ¤œæŸ»é …ç›®è¡ŒHTMLç”Ÿæˆ ===
        function buildCompRowHtml(item) {
            const [n, u] = item.split(':');
            return `<div class="compare-row"><div><input type="checkbox" class="c-chk" value="${n}" data-unit="${u || ''}"> ${n}<span class="item-action-btns"><button onclick="editCompItem(this)" title="åå‰å¤‰æ›´">âœ</button><button onclick="deleteCompItem(this)" title="å‰Šé™¤">âœ•</button></span></div><select class="c-side" onchange="toggleCompSide(this)" style="font-size:11px;padding:4px;"><option value="lr">å·¦å³</option><option value="l">å·¦ã®ã¿</option><option value="r">å³ã®ã¿</option><option value="none">ãªã—</option></select><input type="text" class="c-r in-r" style="grid-column:3"><input type="text" class="c-l in-l" style="grid-column:4"><input type="text" class="c-val" style="display:none;grid-column:3/5"><div style="grid-column:5">${u || ''}</div></div>`;
        }

        // === æ‚£è€…æƒ…å ±ãƒãƒƒã‚¸æ›´æ–° ===
        function syncAndBadge(el) {
            const b = el.closest('.patient-block');
            // ä¼‘æ†©æ™‚é–“åˆ‡æ›¿
            if (el.value === 'ä¼‘æ†©æ™‚é–“') {
                b.classList.add('break-block');
            } else {
                b.classList.remove('break-block');
                sync(el);
            }
            updateInfoBadge(el);
        }

        function updateInfoBadge(el) {
            const b = el.closest('.patient-block');
            if (!b) return;
            const badge = b.querySelector('.patient-info-badge');
            if (!badge) return;
            const age = b.querySelector('.p-age').value;
            const sex = b.querySelector('.p-sex').value;
            const dis = b.querySelector('.p-disease').value;
            let html = '';
            if (age) html += `<span class="badge-item">${age}</span>`;
            if (sex) html += `<span class="badge-item">${sex}</span>`;
            if (dis) html += `<span class="badge-item badge-disease">${dis}</span>`;
            badge.innerHTML = html;
        }

        // === ç–¾æ‚£ã§æ‚£è€…ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œç´¢ ===
        function filterPatientsByDisease() {
            const q = document.getElementById('diseaseSearchInput').value;
            document.querySelectorAll('.patient-block').forEach(b => {
                const dis = b.querySelector('.p-disease').value;
                if (!q) { b.style.display = ''; return; }
                b.style.display = (dis === q) ? '' : 'none';
            });
        }

        function updateDiseaseSearchOptions() {
            const sel = document.getElementById('diseaseSearchInput');
            const cur = sel.value;
            const diseases = document.getElementById('masterDiseases').value.split('\n').filter(v => v);
            sel.innerHTML = '<option value="">ã™ã¹ã¦è¡¨ç¤º</option>' + diseases.map(d => `<option value="${d}">${d}</option>`).join('');
            if (diseases.includes(cur)) sel.value = cur;
            else { sel.value = ''; filterPatientsByDisease(); }
        }

        // === ãƒªãƒé …ç›®è¿½åŠ  ===
        function addRehabItem(btn) {
            const name = prompt('è¿½åŠ ã™ã‚‹ãƒªãƒé …ç›®ã®åå‰ã‚’å…¥åŠ›:');
            if (!name || !name.trim()) return;
            const body = btn.closest('.list-container').querySelector('.rehab-list-body');
            body.insertAdjacentHTML('beforeend', buildRehabRowHtml(name.trim()));
        }

        // === ãƒªãƒé …ç›®åå¤‰æ›´ ===
        function editRehabItem(btn) {
            const row = btn.closest('.list-row');
            const chk = row.querySelector('.r-chk');
            const oldName = chk.value;
            const newName = prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›:', oldName);
            if (!newName || !newName.trim() || newName.trim() === oldName) return;
            chk.value = newName.trim();
            const label = row.querySelector('.list-name');
            // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’æ›´æ–°
            label.childNodes.forEach(node => {
                if (node.nodeType === 3 && node.textContent.trim() === oldName) {
                    node.textContent = newName.trim();
                }
            });
        }

        // === ãƒªãƒé …ç›®å‰Šé™¤ ===
        function deleteRehabItem(btn) {
            const row = btn.closest('.list-row');
            const name = row.querySelector('.r-chk').value;
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            row.remove();
        }

        // === æ¤œæŸ»é …ç›®è¿½åŠ  ===
        function addCompItem(btn) {
            const input = prompt('è¿½åŠ ã™ã‚‹æ¤œæŸ»é …ç›®ã‚’å…¥åŠ› (ä¾‹: MMT(è…¸è…°ç­‹):æ®µéš):');
            if (!input || !input.trim()) return;
            const body = btn.closest('.compare-container').querySelector('.compare-body');
            body.insertAdjacentHTML('beforeend', buildCompRowHtml(input.trim()));
            // éº»ç—ºå´ãƒã‚¤ãƒ©ã‚¤ãƒˆå†é©ç”¨
            const block = btn.closest('.patient-block');
            if (block) highlight(block.querySelector('.p-side'));
        }

        // === æ¤œæŸ»é …ç›®åå¤‰æ›´ ===
        function editCompItem(btn) {
            const row = btn.closest('.compare-row');
            const chk = row.querySelector('.c-chk');
            const oldName = chk.value;
            const oldUnit = chk.dataset.unit || '';
            const newInput = prompt('æ–°ã—ã„é …ç›®å:å˜ä½ã‚’å…¥åŠ› (ä¾‹: BBS:ç‚¹):', oldName + (oldUnit ? ':' + oldUnit : ''));
            if (!newInput || !newInput.trim()) return;
            const [newName, newUnit] = newInput.trim().split(':');
            chk.value = newName;
            chk.dataset.unit = newUnit || '';
            // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’æ›´æ–°
            const firstDiv = row.querySelector('div');
            firstDiv.childNodes.forEach(node => {
                if (node.nodeType === 3 && node.textContent.trim().includes(oldName)) {
                    node.textContent = ' ' + newName;
                }
            });
            // å˜ä½ã‚’æ›´æ–°
            const unitDiv = row.querySelector('div[style*="grid-column:5"]');
            if (unitDiv) unitDiv.textContent = newUnit || '';
        }

        // === æ¤œæŸ»é …ç›®å‰Šé™¤ ===
        function deleteCompItem(btn) {
            const row = btn.closest('.compare-row');
            const name = row.querySelector('.c-chk').value;
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            row.remove();
        }

        function addPatientBlock() {
            const list = document.getElementById('patientList');
            const diseases = document.getElementById('masterDiseases').value.split('\n').filter(v => v);
            const rehabs = document.getElementById('masterRehabs').value.split('\n').filter(v => v);
            const compares = document.getElementById('masterCompare').value.split('\n').filter(v => v);
            const sexOpts = '<option value="">-</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option>';
            const block = document.createElement('div');
            block.className = 'patient-block';

            block.innerHTML = `
            <button class="del-btn" onclick="this.parentElement.remove()">å‰Šé™¤</button>
            <div class="row">
                <div style="width:140px;"><label>æ™‚é–“</label><div style="display:flex;gap:4px"><select class="p-h">${Array.from({ length: 24 }, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('')}</select>:<select class="p-m">${Array.from({ length: 12 }, (_, i) => `<option value="${(i * 5).toString().padStart(2, '0')}">${(i * 5).toString().padStart(2, '0')}</option>`).join('')}</select></div></div>
                <div class="col"><label>æ°å</label><div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;"><select class="p-name" onchange="syncAndBadge(this)"><option value="ä¼‘æ†©æ™‚é–“">â˜• ä¼‘æ†©æ™‚é–“</option>${alphabet.map(n => `<option value="${n}ã•ã‚“">${n}ã•ã‚“</option>`).join('')}</select><button class="menu-btn" style="width:30px;height:30px;font-size:0.8rem" onclick="openChartModal(this.closest('.patient-block').querySelector('.p-name').value)">ğŸ“ˆ</button><label class="case-toggle"><input type="checkbox" class="case-chk" onchange="toggleCasePatient(this)"><span class="case-label">ç—‡ä¾‹</span></label><button class="collapse-btn" onclick="toggleCollapse(this)">â–² ãŸãŸã‚€</button><span class="patient-info-badge"></span></div></div>
                <div style="width:75px;"><label>å¹´é½¢</label><select class="p-age" onchange="updateInfoBadge(this)">${Array.from({ length: 9 }, (_, i) => `<option value="${(i + 1) * 10}ä»£">${(i + 1) * 10}ä»£</option>`).join('')}</select></div>
                <div style="width:65px;"><label>æ€§åˆ¥</label><select class="p-sex" onchange="updateInfoBadge(this)">${sexOpts}</select></div>
                <div style="width:70px;"><label>éº»ç—ºå´</label><select class="p-side" onchange="highlight(this)"><option value="">-</option><option value="å³">å³</option><option value="å·¦">å·¦</option></select></div>
                <div class="col"><label>ç–¾æ‚£</label><div style="display:flex;gap:4px"><select class="p-disease" onchange="updateInfoBadge(this)"><option value="">é¸æŠ</option>${diseases.map(d => `<option value="${d}">${d}</option>`).join('')}</select><select class="p-dis-side" style="width:55px;"><option value="">-</option><option value="å³">å³</option><option value="å·¦">å·¦</option></select></div></div>
            </div>
            <div class="block-content">
            <div class="section-header"><label>ğŸ©º ãƒã‚¤ã‚¿ãƒ«</label><button class="section-reset-btn" onclick="resetVitals(this)">ãƒªã‚»ãƒƒãƒˆ</button></div>
            <div class="row">${['pre', 'post'].map(p => `<div class="vital-sub-block"><div style="font-size:0.7rem;font-weight:bold">${p === 'pre' ? 'ãƒªãƒå‰' : 'ãƒªãƒå¾Œ'}</div><div class="vital-grid"><div><label>è¡€åœ§</label><div style="display:flex;gap:2px"><input type="text" class="v-${p}-s" style="width:35px">/<input type="text" class="v-${p}-d" style="width:35px"></div></div><div><label>è„ˆæ‹</label><input type="text" class="v-${p}-pr"></div><div><label>ä½“æ¸©</label><input type="text" class="v-${p}-bt"></div><div><label>SpO2</label><input type="text" class="v-${p}-sp"></div></div></div>`).join('')}</div>
            
            <div class="section-header"><label>ğŸ“‹ ãƒªãƒå†…å®¹æ¤œç´¢</label><button class="section-reset-btn" onclick="resetRehabs(this)">ãƒªã‚»ãƒƒãƒˆ</button></div>
            <input type="text" class="search-input" placeholder="æ¤œç´¢..." oninput="filterList(this, 'rehab-list-body')">
            <div class="list-container"><div class="rehab-list-body">${rehabs.map(r => buildRehabRowHtml(r)).join('')}</div><button class="add-item-btn" onclick="addRehabItem(this)">ï¼‹ ãƒªãƒé …ç›®ã‚’è¿½åŠ </button></div>
            
            <div class="section-header"><label>ğŸ§  Br.stage</label><button class="section-reset-btn" onclick="resetBrstage(this)">ãƒªã‚»ãƒƒãƒˆ</button></div>
            <div class="row" style="background:#f1f5f9; padding:5px; border-radius:5px;"><div class="col" style="display:flex; gap:10px;"><label>ä¸Šè‚¢<select class="br-ue">${["-", "I", "II", "III", "IV", "V", "VI"].map(s => `<option value="${s}">${s}</option>`).join('')}</select></label><label>æ‰‹æŒ‡<select class="br-ha">${["-", "I", "II", "III", "IV", "V", "VI"].map(s => `<option value="${s}">${s}</option>`).join('')}</select></label><label>ä¸‹è‚¢<select class="br-le">${["-", "I", "II", "III", "IV", "V", "VI"].map(s => `<option value="${s}">${s}</option>`).join('')}</select></label></div></div>

            <div class="section-header"><label>âš–ï¸ å·¦å³è©•ä¾¡ãƒ»æ¤œæŸ»æ¤œç´¢</label><button class="section-reset-btn" onclick="resetComps(this)">ãƒªã‚»ãƒƒãƒˆ</button></div>
            <input type="text" class="search-input" placeholder="æ¤œç´¢..." oninput="filterList(this, 'compare-body')">
            <div class="compare-container"><div class="compare-body">
                <div class="compare-row" style="background:#fef3c7; font-weight:bold;"><div>é …ç›®</div><div>å´</div><div>å³</div><div>å·¦</div><div>å˜ä½</div></div>
                ${compares.map(item => buildCompRowHtml(item)).join('')}
            </div><button class="add-item-btn" onclick="addCompItem(this)">ï¼‹ æ¤œæŸ»é …ç›®ã‚’è¿½åŠ </button></div>

            <div class="soap-field soap-s-field"><label>ğŸ—£ï¸ Sï¼ˆä¸»è¦³çš„æƒ…å ±ï¼‰</label><textarea class="p-soap-s" rows="3" placeholder="æ‚£è€…ã®è¨´ãˆã€å¸Œæœ›ã€æ„Ÿæƒ³ãªã©"></textarea></div>
            <div class="row"><div class="col"><div class="section-header"><label>ğŸ’¡ å­¦ã³ãƒ»ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆï¼ˆâš ï¸é‡è¦ï¼‰</label><button class="section-reset-btn" onclick="resetTextarea(this, '.p-ins')">ãƒªã‚»ãƒƒãƒˆ</button></div><textarea class="p-ins" rows="4"></textarea></div></div>
            <div class="row"><div class="col"><div class="section-header"><label>ğŸ’¬ å‚™è€ƒï¼ˆå¤§å‹ï¼‰</label><button class="section-reset-btn" onclick="resetTextarea(this, '.p-rem')">ãƒªã‚»ãƒƒãƒˆ</button></div><textarea class="p-rem" rows="4"></textarea></div></div>
            <div class="soap-field soap-p-field"><label>ğŸ Pï¼ˆè¨ˆç”»ï¼‰</label><textarea class="p-soap-p" rows="3" placeholder="ä»Šå¾Œã®æ²»ç™‚è¨ˆç”»ã€ç›®æ¨™ãªã©"></textarea></div>
            <div class="row">
                <div class="col"><div class="section-header"><label>ğŸ§  é«˜æ¬¡è„³</label><button class="section-reset-btn" onclick="resetHbDs(this, '.p-hb', '.p-hb-d')">ãƒªã‚»ãƒƒãƒˆ</button></div><select class="p-hb" onchange="tgD(this)"><option value="ãªã—">ãªã—</option><option value="ã‚ã‚Š">ã‚ã‚Š</option></select><input type="text" class="p-hb-d detail-input"></div>
                <div class="col"><div class="section-header"><label>ğŸ¦¼ è£œåŠ©å…·</label><button class="section-reset-btn" onclick="resetHbDs(this, '.p-ds', '.p-ds-d')">ãƒªã‚»ãƒƒãƒˆ</button></div><select class="p-ds" onchange="tgD(this)"><option value="ãªã—">ãªã—</option><option value="ã‚ã‚Š">ã‚ã‚Š</option></select><input type="text" class="p-ds-d detail-input"></div>
            </div>
            </div>
        `;
            // ä¼‘æ†©æ™‚é–“ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æœ€åˆã‹ã‚‰æŠ˜ã‚ŠãŸãŸã¿
            if (block.querySelector('.p-name').value === 'ä¼‘æ†©æ™‚é–“') {
                block.classList.add('break-block');
            }
            list.appendChild(block);
        }

        function sortR(el) { const b = el.closest('.rehab-list-body'); const rows = Array.from(b.children); rows.sort((x, y) => (x.querySelector('input').checked === y.querySelector('input').checked) ? 0 : x.querySelector('input').checked ? -1 : 1); rows.forEach(r => { r.classList.toggle('checked-row', r.querySelector('input').checked); b.appendChild(r); }); }
        function tgD(el) { el.nextElementSibling.style.display = (el.value === "ã‚ã‚Š") ? "block" : "none"; }
        function highlight(el) { const b = el.closest('.patient-block'); b.querySelectorAll('.in-l').forEach(i => i.classList.toggle('paralysis-highlight', el.value === 'å·¦')); b.querySelectorAll('.in-r').forEach(i => i.classList.toggle('paralysis-highlight', el.value === 'å³')); }

        function toggleCompSide(sel) {
            const row = sel.closest('.compare-row');
            const cL = row.querySelector('.c-l');
            const cR = row.querySelector('.c-r');
            const cV = row.querySelector('.c-val');
            const v = sel.value;
            if (v === 'lr') { cR.style.display = ''; cL.style.display = ''; cV.style.display = 'none'; }
            else if (v === 'l') { cR.style.display = 'none'; cR.value = ''; cL.style.display = ''; cV.style.display = 'none'; }
            else if (v === 'r') { cR.style.display = ''; cL.style.display = 'none'; cL.value = ''; cV.style.display = 'none'; }
            else { cR.style.display = 'none'; cR.value = ''; cL.style.display = 'none'; cL.value = ''; cV.style.display = ''; }
        }

        function sync(el) {
            const name = el.value; const b = el.closest('.patient-block');
            let raw;
            try { raw = localStorage.getItem(DB_PREFIX + 'full_mem_' + name); } catch (e) { return; }
            if (!raw) return;
            let data;
            try { data = JSON.parse(raw); } catch (e) { return; }
            if (!data || !data.p) return;

            const p = data.p;
            if (p.age) b.querySelector('.p-age').value = p.age;
            if (p.sex) b.querySelector('.p-sex').value = p.sex;
            if (p.side) { b.querySelector('.p-side').value = p.side; highlight(b.querySelector('.p-side')); }
            if (p.dis) {
                const diseaseEl = b.querySelector('.p-disease');
                // é¸æŠè‚¢ã«ãªã„å ´åˆã¯optionã‚’è¿½åŠ 
                if (![...diseaseEl.options].some(o => o.value === p.dis)) {
                    const opt = document.createElement('option'); opt.value = p.dis; opt.textContent = p.dis; diseaseEl.appendChild(opt);
                }
                diseaseEl.value = p.dis;
            }
            if (p.disSide) b.querySelector('.p-dis-side').value = p.disSide;
            if (p.hbS !== undefined) { b.querySelector('.p-hb').value = p.hbS; tgD(b.querySelector('.p-hb')); }
            if (p.hbD !== undefined) b.querySelector('.p-hb-d').value = p.hbD;
            if (p.dsS !== undefined) { b.querySelector('.p-ds').value = p.dsS; tgD(b.querySelector('.p-ds')); }
            if (p.dsD !== undefined) b.querySelector('.p-ds-d').value = p.dsD;
            // æ™‚é–“ã®å¾©å…ƒ
            if (p.h) b.querySelector('.p-h').value = p.h;
            if (p.m !== undefined) b.querySelector('.p-m').value = p.m;
            // å­¦ã³ãƒ»å‚™è€ƒã‚’å¾©å…ƒ
            if (p.ins !== undefined) b.querySelector('.p-ins').value = p.ins;
            if (p.rem !== undefined) b.querySelector('.p-rem').value = p.rem;

            // Br.stage
            if (data.br) {
                if (data.br.ue !== undefined) b.querySelector('.br-ue').value = data.br.ue;
                if (data.br.ha !== undefined) b.querySelector('.br-ha').value = data.br.ha;
                if (data.br.le !== undefined) b.querySelector('.br-le').value = data.br.le;
            }

            // ãƒã‚¤ã‚¿ãƒ«ï¼ˆå‰å¾Œï¼‰ã®å¾©å…ƒ
            if (data.vitals) {
                const v = data.vitals;
                if (v.preS) b.querySelector('.v-pre-s').value = v.preS;
                if (v.preD) b.querySelector('.v-pre-d').value = v.preD;
                if (v.prePr) b.querySelector('.v-pre-pr').value = v.prePr;
                if (v.preBt) b.querySelector('.v-pre-bt').value = v.preBt;
                if (v.preSp) b.querySelector('.v-pre-sp').value = v.preSp;
                if (v.postS) b.querySelector('.v-post-s').value = v.postS;
                if (v.postD) b.querySelector('.v-post-d').value = v.postD;
                if (v.postPr) b.querySelector('.v-post-pr').value = v.postPr;
                if (v.postBt) b.querySelector('.v-post-bt').value = v.postBt;
                if (v.postSp) b.querySelector('.v-post-sp').value = v.postSp;
            }

            // ãƒªãƒãƒ“ãƒªå†…å®¹ã®å¾©å…ƒ
            if (data.rehabs) {
                b.querySelectorAll('.rehab-list-body .list-row').forEach(row => {
                    const chk = row.querySelector('.r-chk'); const s = data.rehabs.find(r => r.n === chk.value);
                    if (s) { chk.checked = true; row.classList.add('checked-row'); if (s.min !== undefined && s.min !== '') row.querySelector('.r-min').value = s.min; if (s.sec !== undefined && s.sec !== '') row.querySelector('.r-sec').value = s.sec; row.querySelector('.r-c').value = s.c; row.querySelector('.r-s').value = s.s; if (row.querySelector('.r-m') && s.m !== undefined) row.querySelector('.r-m').value = s.m; row.querySelector('.r-nrs').value = s.nrs; row.querySelector('.r-bg').value = s.bg; } else { chk.checked = false; row.classList.remove('checked-row'); }
                });
                // ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸Šã«ä¸¦ã¹æ›¿ãˆ
                const body = b.querySelector('.rehab-list-body');
                const rows = Array.from(body.children);
                rows.sort((x, y) => (x.querySelector('input').checked === y.querySelector('input').checked) ? 0 : x.querySelector('input').checked ? -1 : 1);
                rows.forEach(r => body.appendChild(r));
            }

            // è©•ä¾¡é …ç›®ã®å¾©å…ƒ
            if (data.comps) {
                b.querySelectorAll('.compare-body .compare-row').forEach(row => {
                    const chk = row.querySelector('.c-chk'); if (!chk) return; const s = data.comps.find(c => c.n === chk.value);
                    if (s) {
                        chk.checked = true;
                        if (s.sd) { const sideEl = row.querySelector('.c-side'); sideEl.value = s.sd; toggleCompSide(sideEl); }
                        if (s.sd === 'none') {
                            row.querySelector('.c-val').value = s.l || '';
                        } else {
                            if (row.querySelector('.c-l')) row.querySelector('.c-l').value = s.l || '';
                            if (row.querySelector('.c-r')) row.querySelector('.c-r').value = s.r || '';
                        }
                    } else { chk.checked = false; }
                });
            }
            // æƒ…å ±ãƒãƒƒã‚¸æ›´æ–°
            updateInfoBadge(el);
        }

        function generateNote() {
            const date = document.getElementById('dateInput').value; let note = `ç†å­¦ç™‚æ³•å®Ÿç¿’ ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆ (${date})\n\n`;
            let warnings = []; let lastT = -1;

            document.querySelectorAll('.patient-block').forEach(b => {
                const name = b.querySelector('.p-name').value; const h = b.querySelector('.p-h').value, m = b.querySelector('.p-m').value;
                const curT = parseInt(h) * 60 + parseInt(m); const age = b.querySelector('.p-age').value;
                const sex = b.querySelector('.p-sex').value;
                const ins = b.querySelector('.p-ins').value.trim(); const side = b.querySelector('.p-side').value; const dis = b.querySelector('.p-disease').value;
                const disSide = b.querySelector('.p-dis-side').value;

                if (curT <= lastT) warnings.push(`${name}: æ™‚é–“é€†è»¢`); lastT = curT;
                if (["10ä»£", "20ä»£", "30ä»£", "40ä»£"].includes(age)) warnings.push(`${name}: è‹¥å¹´å±¤é…æ…®`);
                if (!ins) warnings.push(`${name}: å­¦ã³ç©ºæ¬„`);

                // ãƒã‚¤ã‚¿ãƒ«ç•°å¸¸å€¤ãƒã‚§ãƒƒã‚¯
                const preS = parseInt(b.querySelector('.v-pre-s').value);
                const prePr = parseInt(b.querySelector('.v-pre-pr').value);
                if (preS > 200) warnings.push(`${name}: å®‰é™æ™‚è¡€åœ§(ä¸Š) ${preS} â†’ 200è¶…`);
                const preD = parseInt(b.querySelector('.v-pre-d').value);
                if (preD > 120) warnings.push(`${name}: å®‰é™æ™‚è¡€åœ§(ä¸‹) ${preD} â†’ 120è¶…`);
                if (prePr > 120) warnings.push(`${name}: å®‰é™æ™‚è„ˆæ‹ ${prePr} â†’ 120è¶…`);

                let sessionRehabs = []; b.querySelectorAll('.r-chk:checked').forEach(c => {
                    const row = c.closest('.list-row'); sessionRehabs.push({ n: c.value, min: row.querySelector('.r-min').value, sec: row.querySelector('.r-sec').value, c: row.querySelector('.r-c').value, s: row.querySelector('.r-s').value, m: row.querySelector('.r-m') ? row.querySelector('.r-m').value : '', nrs: row.querySelector('.r-nrs').value, bg: row.querySelector('.r-bg').value });
                });
                let sessionComps = []; b.querySelectorAll('.c-chk:checked').forEach(c => {
                    const row = c.closest('.compare-row');
                    const unit = c.dataset.unit || '';
                    const sd = row.querySelector('.c-side').value;
                    if (sd === 'none') {
                        sessionComps.push({ n: c.value, sd, l: row.querySelector('.c-val').value, r: '', u: unit });
                    } else {
                        sessionComps.push({ n: c.value, sd, l: row.querySelector('.c-l').value, r: row.querySelector('.c-r').value, u: unit });
                    }
                });

                // Br.stage
                const brUe = b.querySelector('.br-ue').value, brHa = b.querySelector('.br-ha').value, brLe = b.querySelector('.br-le').value;
                // é«˜æ¬¡è„³ãƒ»è£œåŠ©å…·
                const hbS = b.querySelector('.p-hb').value, hbD = b.querySelector('.p-hb-d').value;
                const dsS = b.querySelector('.p-ds').value, dsD = b.querySelector('.p-ds-d').value;

                // å­¦ã³ãƒ»å‚™è€ƒã‚’æ—¥ä»˜ä»˜ãå±¥æ­´ã¨ã—ã¦ä¿å­˜
                const rem = b.querySelector('.p-rem').value.trim();
                if (ins || rem) {
                    let insHist = JSON.parse(localStorage.getItem(DB_PREFIX + 'ins_hist_' + name)) || [];
                    insHist.push({ date, ins: ins, rem: rem });
                    localStorage.setItem(DB_PREFIX + 'ins_hist_' + name, JSON.stringify(insHist.slice(-50)));
                }

                localStorage.setItem(DB_PREFIX + 'full_mem_' + name, JSON.stringify({
                    p: { age, sex, side, dis, disSide, hbS, hbD, dsS, dsD, h, m, ins, rem },
                    br: { ue: brUe, ha: brHa, le: brLe },
                    vitals: {
                        preS: b.querySelector('.v-pre-s').value, preD: b.querySelector('.v-pre-d').value,
                        prePr: b.querySelector('.v-pre-pr').value, preBt: b.querySelector('.v-pre-bt').value, preSp: b.querySelector('.v-pre-sp').value,
                        postS: b.querySelector('.v-post-s').value, postD: b.querySelector('.v-post-d').value,
                        postPr: b.querySelector('.v-post-pr').value, postBt: b.querySelector('.v-post-bt').value, postSp: b.querySelector('.v-post-sp').value
                    },
                    rehabs: sessionRehabs, comps: sessionComps
                }));

                let hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'hist_' + name)) || [];
                // åŒã˜æ—¥ä»˜ã®ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Œã°ä¸Šæ›¸ã
                const existIdx = hist.findIndex(h => h.date === date);
                const histEntry = { date, vPreS: b.querySelector('.v-pre-s').value, vPreD: b.querySelector('.v-pre-d').value, vPrePr: b.querySelector('.v-pre-pr').value, vPreBt: b.querySelector('.v-pre-bt').value, vPreSp: b.querySelector('.v-pre-sp').value, vPostS: b.querySelector('.v-post-s').value, vPostD: b.querySelector('.v-post-d').value, vPostPr: b.querySelector('.v-post-pr').value, vPostBt: b.querySelector('.v-post-bt').value, vPostSp: b.querySelector('.v-post-sp').value, comps: sessionComps };
                if (existIdx >= 0) { hist[existIdx] = histEntry; } else { hist.push(histEntry); }
                localStorage.setItem(DB_PREFIX + 'hist_' + name, JSON.stringify(hist.slice(-30)));

                // ãƒãƒ¼ãƒˆå‡ºåŠ›
                note += `ã€${h}:${m}ã€‘ ${name}ï¼ˆ${age}${sex ? 'ãƒ»' + sex : ''}ãƒ»${side || '-'}ï¼‰ ç–¾æ‚£ï¼š${dis}${disSide ? 'ï¼ˆ' + disSide + 'ï¼‰' : ''}\n`;

                // ãƒã‚¤ã‚¿ãƒ«ï¼ˆå‰å¾Œï¼‰
                const vPreS = b.querySelector('.v-pre-s').value, vPreD = b.querySelector('.v-pre-d').value;
                const vPrePrV = b.querySelector('.v-pre-pr').value, vPreBt = b.querySelector('.v-pre-bt').value, vPreSp = b.querySelector('.v-pre-sp').value;
                const vPostS = b.querySelector('.v-post-s').value, vPostD = b.querySelector('.v-post-d').value;
                const vPostPr = b.querySelector('.v-post-pr').value, vPostBt = b.querySelector('.v-post-bt').value, vPostSp = b.querySelector('.v-post-sp').value;
                if (vPreS) note += `å‰) BP:${vPreS}/${vPreD} PR:${vPrePrV} BT:${vPreBt || '-'}â„ƒ SpO2:${vPreSp || '-'}%\n`;
                if (vPostS) note += `å¾Œ) BP:${vPostS}/${vPostD} PR:${vPostPr} BT:${vPostBt || '-'}â„ƒ SpO2:${vPostSp || '-'}%\n`;

                // Br.stage
                if (side && (brUe !== '-' || brHa !== '-' || brLe !== '-')) {
                    note += `Br.stage: ä¸Šè‚¢${brUe} æ‰‹æŒ‡${brHa} ä¸‹è‚¢${brLe}\n`;
                }

                // é«˜æ¬¡è„³ãƒ»è£œåŠ©å…·
                if (hbS === 'ã‚ã‚Š') note += `é«˜æ¬¡è„³æ©Ÿèƒ½éšœå®³: ${hbD || 'è©³ç´°æœªè¨˜å…¥'}\n`;
                if (dsS === 'ã‚ã‚Š') note += `è£œåŠ©å…·: ${dsD || 'è©³ç´°æœªè¨˜å…¥'}\n`;

                // ãƒªãƒå†…å®¹ï¼ˆæ™‚é–“ãƒ»Borgå«ã‚€ï¼‰
                if (sessionRehabs.length) note += `å†…å®¹:\n${sessionRehabs.map(r => { let parts = []; if (r.min || r.sec) parts.push(`${r.min || '0'}åˆ†${r.sec || '0'}ç§’`); if (r.c !== '0' && r.c !== '') parts.push(`${r.c}å›`); if (r.s !== '0' && r.s !== '') parts.push(`${r.s}set`); if (r.m && r.m !== '') parts.push(`${r.m}m`); if (r.nrs && r.nrs !== '') parts.push(`NRS:${r.nrs}`); if (r.bg && r.bg !== '') parts.push(`Borg:${r.bg}`); return ` ãƒ»${r.n}${parts.length ? ' ' + parts.join(' ') : ''}`; }).join('\n')}\n`;

                // è©•ä¾¡é …ç›®ï¼ˆå·¦å³ãƒ»å˜ä½ï¼‰
                if (sessionComps.length) note += `è©•ä¾¡:\n${sessionComps.map(c => {
                    if (c.sd === 'lr') return ` ãƒ»${c.n}: å·¦${c.l || '-'} / å³${c.r || '-'} ${c.u}`;
                    if (c.sd === 'l') return ` ãƒ»${c.n}: å·¦${c.l || '-'} ${c.u}`;
                    if (c.sd === 'r') return ` ãƒ»${c.n}: å³${c.r || '-'} ${c.u}`;
                    return ` ãƒ»${c.n}: ${c.l || c.r || '-'} ${c.u}`;
                }).join('\n')}\n`;

                if (ins) note += `å­¦ã³:\n${ins}\n`;
                if (b.querySelector('.p-rem').value) note += `å‚™è€ƒ: ${b.querySelector('.p-rem').value}\n`;
                note += `\n`;

                // ç—‡ä¾‹æ‚£è€…ã®å ´åˆã€SOAPçµŒéè¨˜éŒ²ã«è‡ªå‹•ä¿å­˜
                const caseChk = b.querySelector('.case-chk');
                if (caseChk && caseChk.checked) {
                    const soapS = b.querySelector('.p-soap-s') ? b.querySelector('.p-soap-s').value.trim() : '';
                    const soapP = b.querySelector('.p-soap-p') ? b.querySelector('.p-soap-p').value.trim() : '';
                    // O = æ¤œæŸ»é …ç›®ãƒ†ã‚­ã‚¹ãƒˆ
                    let oText = '';
                    if (sessionComps.length) {
                        oText = sessionComps.map(c => {
                            if (c.sd === 'lr') return `${c.n}: å·¦${c.l || '-'} / å³${c.r || '-'} ${c.u}`;
                            if (c.sd === 'l') return `${c.n}: å·¦${c.l || '-'} ${c.u}`;
                            if (c.sd === 'r') return `${c.n}: å³${c.r || '-'} ${c.u}`;
                            return `${c.n}: ${c.l || c.r || '-'} ${c.u}`;
                        }).join('\n');
                    }
                    // A = å­¦ã³
                    const aText = ins;
                    // SOAPä¿å­˜
                    const soapData = { date, s: soapS, o: oText, a: aText, p: soapP };
                    let soapHist = JSON.parse(localStorage.getItem(DB_PREFIX + 'soap_' + name)) || [];
                    const sIdx = soapHist.findIndex(h => h.date === date);
                    if (sIdx >= 0) { soapHist[sIdx] = soapData; } else { soapHist.push(soapData); }
                    soapHist.sort((a, b) => a.date.localeCompare(b.date));
                    localStorage.setItem(DB_PREFIX + 'soap_' + name, JSON.stringify(soapHist));
                }
            });

            if (warnings.length > 0 && !confirm("è­¦å‘ŠãŒã‚ã‚Šã¾ã™ã€‚å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ\n" + warnings.join("\n"))) return;
            document.getElementById('output').innerText = note; document.getElementById('output').style.display = 'block';
            document.getElementById('copy-note-btn').style.display = 'inline-block';
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(note).then(() => alert("ä½œæˆå®Œäº†ï¼å…¨ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜æ†¶ã—ã¾ã—ãŸã€‚")).catch(() => alert("ä½œæˆå®Œäº†ï¼ï¼ˆã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¯æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰"));
            } else {
                alert("ä½œæˆå®Œäº†ï¼ï¼ˆã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¯æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰");
            }
        }

        let currentChartName = '';

        function switchChartTab(tab) {
            document.getElementById('vital-chart-area').style.display = tab === 'vital' ? 'block' : 'none';
            document.getElementById('score-chart-area').style.display = tab === 'score' ? 'block' : 'none';
            document.getElementById('tab-vital').style.background = tab === 'vital' ? 'var(--primary)' : 'white';
            document.getElementById('tab-vital').style.color = tab === 'vital' ? 'white' : 'var(--primary)';
            document.getElementById('tab-score').style.background = tab === 'score' ? 'var(--primary)' : 'white';
            document.getElementById('tab-score').style.color = tab === 'score' ? 'white' : 'var(--primary)';
            if (tab === 'score') renderScoreChart(currentChartName);
        }

        function openChartModal(name) {
            currentChartName = name;
            document.getElementById('chart-title').innerText = `${name} æ¨ç§»`;
            const history = JSON.parse(localStorage.getItem(DB_PREFIX + 'hist_' + name)) || [];
            if (!history.length) return alert("ãƒ‡ãƒ¼ã‚¿ä¸è¶³");
            if (vitalChartInstance) vitalChartInstance.destroy();
            vitalChartInstance = new Chart(document.getElementById('vitalChart'), {
                type: 'line', data: {
                    labels: history.map(h => h.date), datasets: [
                        { label: 'å‰)è¡€åœ§(ä¸Š)', data: history.map(h => parseInt(h.vPreS) || null), borderColor: '#ef4444', pointRadius: 4, borderWidth: 2 },
                        { label: 'å‰)è¡€åœ§(ä¸‹)', data: history.map(h => parseInt(h.vPreD) || null), borderColor: '#f97316', pointRadius: 3, borderWidth: 1.5, borderDash: [5, 3] },
                        { label: 'å‰)è„ˆæ‹', data: history.map(h => parseInt(h.vPrePr) || null), borderColor: '#3b82f6', pointRadius: 4, borderWidth: 2 },
                        { label: 'å‰)SpO2', data: history.map(h => parseInt(h.vPreSp) || null), borderColor: '#10b981', pointRadius: 3, borderWidth: 1.5 },
                        { label: 'å¾Œ)è¡€åœ§(ä¸Š)', data: history.map(h => parseInt(h.vPostS) || null), borderColor: '#dc2626', pointRadius: 4, borderWidth: 2, borderDash: [8, 4] },
                        { label: 'å¾Œ)è¡€åœ§(ä¸‹)', data: history.map(h => parseInt(h.vPostD) || null), borderColor: '#ea580c', pointRadius: 3, borderWidth: 1.5, borderDash: [3, 3] },
                        { label: 'å¾Œ)è„ˆæ‹', data: history.map(h => parseInt(h.vPostPr) || null), borderColor: '#2563eb', pointRadius: 4, borderWidth: 2, borderDash: [8, 4] },
                        { label: 'å¾Œ)SpO2', data: history.map(h => parseInt(h.vPostSp) || null), borderColor: '#059669', pointRadius: 3, borderWidth: 1.5, borderDash: [8, 4] }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, usePointStyle: true } } } }
            });
            switchChartTab('vital');
            document.getElementById('chart-modal').style.display = 'block';
        }

        function renderScoreChart(name) {
            const history = JSON.parse(localStorage.getItem(DB_PREFIX + 'hist_' + name)) || [];
            if (!history.length) return;
            // å…¨å±¥æ­´ã‹ã‚‰æ¤œæŸ»é …ç›®åã‚’åé›†
            const itemNames = new Set();
            history.forEach(h => { if (h.comps) h.comps.forEach(c => itemNames.add(c.n)); });
            if (!itemNames.size) {
                if (scoreChartInstance) { scoreChartInstance.destroy(); scoreChartInstance = null; }
                const area = document.getElementById('score-chart-area');
                let msg = area.querySelector('.no-data-msg');
                if (!msg) { msg = document.createElement('p'); msg.className = 'no-data-msg'; msg.style.cssText = 'color:#94a3b8;text-align:center;padding:30px 0;'; area.insertBefore(msg, area.firstChild); }
                msg.textContent = 'æ¤œæŸ»çµæœã®å±¥æ­´ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“';
                document.getElementById('scoreChart').style.display = 'none';
                return;
            }
            const oldMsg = document.getElementById('score-chart-area').querySelector('.no-data-msg');
            if (oldMsg) oldMsg.remove();
            document.getElementById('scoreChart').style.display = '';

            // å€¤ã®ãƒ‘ãƒ¼ã‚¹ï¼ˆ"0"ã‚‚nullã§ã¯ãªã0ã¨ã—ã¦æ‰±ã†ï¼‰
            function parseVal(v) {
                if (v === undefined || v === null || v === '') return null;
                const n = parseFloat(v);
                return isNaN(n) ? null : n;
            }

            const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'];
            const datasets = [];
            let idx = 0;
            itemNames.forEach(itemName => {
                // ç©ºæ–‡å­—åˆ—ã§ã¯ãªãå®Ÿéš›ã«å€¤ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const hasL = history.some(h => h.comps && h.comps.find(cc => cc.n === itemName && cc.l !== undefined && cc.l !== ''));
                const hasR = history.some(h => h.comps && h.comps.find(cc => cc.n === itemName && cc.r !== undefined && cc.r !== ''));
                const color = colors[idx % colors.length];
                const baseOpts = { tension: 0.3, spanGaps: true, pointRadius: 4, pointHoverRadius: 6, borderWidth: 2, yAxisID: 'y' + idx };
                if (hasL) {
                    datasets.push({
                        ...baseOpts,
                        label: `${itemName}(å·¦)`,
                        data: history.map(h => { const cc = h.comps && h.comps.find(cc => cc.n === itemName); return cc ? parseVal(cc.l) : null; }),
                        borderColor: color, backgroundColor: color + '20'
                    });
                }
                if (hasR) {
                    datasets.push({
                        ...baseOpts,
                        label: `${itemName}(å³)`,
                        data: history.map(h => { const cc = h.comps && h.comps.find(cc => cc.n === itemName); return cc ? parseVal(cc.r) : null; }),
                        borderColor: color, backgroundColor: color + '20', borderDash: [5, 5]
                    });
                }
                // å·¦å³ã©ã¡ã‚‰ã‚‚ç©ºã®å ´åˆã§ã‚‚é …ç›®è‡ªä½“ã¯å­˜åœ¨ã™ã‚‹ã®ã§è¡¨ç¤º
                if (!hasL && !hasR) {
                    datasets.push({
                        ...baseOpts,
                        label: itemName,
                        data: history.map(h => { const cc = h.comps && h.comps.find(cc => cc.n === itemName); if (!cc) return null; return parseVal(cc.l) !== null ? parseVal(cc.l) : parseVal(cc.r); }),
                        borderColor: color, backgroundColor: color + '20'
                    });
                }
                idx++;
            });
            // å¤šè»¸è¨­å®šï¼ˆå…¨è»¸ã‚’è¡¨ç¤ºã€è¦‹ã‚„ã™ã•ã®ãŸã‚äº¤äº’ã«å·¦å³é…ç½®ï¼‰
            const scales = { x: { display: true, ticks: { font: { size: 10 } } } };
            let axisIdx = 0;
            const totalAxes = itemNames.size;
            itemNames.forEach(itemName => {
                const unit = history.flatMap(h => (h.comps || []).filter(cc => cc.n === itemName && cc.u)).map(cc => cc.u)[0] || '';
                scales['y' + axisIdx] = {
                    type: 'linear', display: true,
                    position: axisIdx % 2 === 0 ? 'left' : 'right',
                    title: { display: true, text: `${itemName}${unit ? '(' + unit + ')' : ''}`, font: { size: totalAxes > 4 ? 8 : 10 } },
                    ticks: { font: { size: totalAxes > 4 ? 8 : 10 } },
                    grid: { drawOnChartArea: axisIdx === 0 }
                };
                axisIdx++;
            });
            if (scoreChartInstance) scoreChartInstance.destroy();
            scoreChartInstance = new Chart(document.getElementById('scoreChart'), {
                type: 'line',
                data: { labels: history.map(h => h.date), datasets },
                options: {
                    responsive: true, interaction: { mode: 'index', intersect: false }, scales,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 10 }, usePointStyle: true } },
                        tooltip: { callbacks: { label: function (ctx) { return ctx.dataset.label + ': ' + (ctx.parsed.y !== null ? ctx.parsed.y : '-'); } } }
                    }
                }
            });
        }

        function showInsHistory() {
            const sel = document.getElementById('ins-history-patient');
            sel.innerHTML = '<option value="">-- æ‚£è€…ã‚’é¸æŠ --</option>';
            // localStorageã‹ã‚‰ins_hist_ã®ã‚ã‚‹æ‚£è€…åã‚’åé›†
            const patients = [];
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith(DB_PREFIX + 'ins_hist_')) {
                    patients.push(k.replace(DB_PREFIX + 'ins_hist_', ''));
                }
            }
            patients.sort();
            patients.forEach(p => {
                const opt = document.createElement('option'); opt.value = p; opt.textContent = p; sel.appendChild(opt);
            });
            document.getElementById('ins-history-content').innerHTML = patients.length ? '<p style="color:#94a3b8;text-align:center;">æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p>' : '<p style="color:#94a3b8;text-align:center;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            document.getElementById('ins-history-modal').style.display = 'block';
        }

        function escHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function loadInsHistory() {
            const name = document.getElementById('ins-history-patient').value;
            const cont = document.getElementById('ins-history-content');
            if (!name) { cont.innerHTML = '<p style="color:#94a3b8;text-align:center;">æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
            const hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'ins_hist_' + name)) || [];
            if (!hist.length) { cont.innerHTML = '<p style="color:#94a3b8;text-align:center;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }
            // æ–°ã—ã„é †ã«è¡¨ç¤º
            const reversed = [...hist].reverse();
            let html = '';
            reversed.forEach((entry, i) => {
                html += `<div style="border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-bottom:8px; background:${i % 2 === 0 ? '#f8fafc' : '#fff'};">`;
                html += `<div style="font-weight:bold; color:var(--primary); font-size:0.85rem; margin-bottom:5px;">ğŸ“… ${escHtml(entry.date || 'æ—¥ä»˜ãªã—')}</div>`;
                if (entry.ins) html += `<div style="margin-bottom:4px;"><span style="font-weight:bold;color:#475569;font-size:0.75rem;">ğŸ’¡ å­¦ã³ãƒ»ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ</span><div style="white-space:pre-wrap;font-size:0.8rem;padding:5px;background:#f0fdf4;border-radius:4px;border:1px solid #bbf7d0;">${escHtml(entry.ins)}</div></div>`;
                if (entry.rem) html += `<div><span style="font-weight:bold;color:#475569;font-size:0.75rem;">ğŸ’¬ å‚™è€ƒ</span><div style="white-space:pre-wrap;font-size:0.8rem;padding:5px;background:#eff6ff;border-radius:4px;border:1px solid #bfdbfe;">${escHtml(entry.rem)}</div></div>`;
                html += '</div>';
            });
            cont.innerHTML = html;
        }

        function generateVerbalScript() {
            let s = ""; document.querySelectorAll('.patient-block').forEach(b => {
                const name = b.querySelector('.p-name').value;
                const sex = b.querySelector('.p-sex').value;
                const age = b.querySelector('.p-age').value;
                const dis = b.querySelector('.p-disease').value;
                const disSide = b.querySelector('.p-dis-side').value;
                const side = b.querySelector('.p-side').value;
                const h = b.querySelector('.p-h').value;
                const ins = b.querySelector('.p-ins').value;
                const disText = dis ? `${dis}${disSide ? '(' + disSide + ')' : ''}` : '';
                s += `ã€${name}ã€‘${age}${sex ? ' ' + sex : ''}${side ? ' éº»ç—ºå´:' + side : ''}${disText ? ' ' + disText : ''}\nã€Œ${h}æ™‚ã‚ˆã‚Šä»‹å…¥ã€‚ãƒã‚¤ã‚¿ãƒ«å®‰å®šã€‚ä»Šæ—¥ã¯ã€œã‚’å®Ÿæ–½ã€‚ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã¨ã—ã¦${ins.substring(0, 40)}...ã¨è€ƒãˆã¾ã—ãŸã€‚ã€\n\n`;
            });
            document.getElementById('script-cont').innerText = s || "ãƒ‡ãƒ¼ã‚¿ãªã—"; document.getElementById('script-modal').style.display = 'block';
        }

        function exportData() {
            const data = {}; for (let i = 0; i < localStorage.length; i++) { const k = localStorage.key(i); if (k.startsWith(DB_PREFIX)) data[k] = localStorage.getItem(k); }
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `PT_Practice_Backup.json`; a.click();
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let count = 0;
                    for (const key in data) {
                        localStorage.setItem(key, data[key]);
                        count++;
                    }
                    alert(`âœ… ${count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­è¾¼ã—ã¾ã™ã€‚`);
                    location.reload();
                } catch (err) {
                    alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function showDataStatus() {
            const bar = document.getElementById('data-status-bar');
            let patientCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                if (localStorage.key(i).startsWith(DB_PREFIX + 'full_mem_')) patientCount++;
            }
            if (patientCount > 0) {
                bar.style.background = '#d1fae5';
                bar.style.color = '#065f46';
                bar.style.borderTop = '2px solid #10b981';
                bar.innerHTML = `âœ… ${patientCount}ååˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™`;
            } else {
                bar.style.background = '#fef3c7';
                bar.style.color = '#92400e';
                bar.style.borderTop = '2px solid #f59e0b';
                bar.innerHTML = 'âš ï¸ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã° <button onclick="importData()" style="background:#f59e0b;color:white;border:none;padding:3px 10px;border-radius:4px;font-size:0.8rem;cursor:pointer;">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</button> ã—ã¦ãã ã•ã„';
            }
            bar.style.display = 'block';
            setTimeout(() => { if (patientCount > 0) { bar.style.opacity = '0'; setTimeout(() => { bar.style.display = 'none'; bar.style.opacity = '1'; }, 500); } }, 4000);
        }

        // === ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ãƒªã‚»ãƒƒãƒˆé–¢æ•° ===
        function resetVitals(btn) {
            const b = btn.closest('.patient-block');
            b.querySelectorAll('.v-pre-s,.v-pre-d,.v-pre-pr,.v-pre-bt,.v-pre-sp,.v-post-s,.v-post-d,.v-post-pr,.v-post-bt,.v-post-sp').forEach(el => el.value = '');
        }
        function resetRehabs(btn) {
            const b = btn.closest('.patient-block');
            b.querySelectorAll('.rehab-list-body .list-row').forEach(row => {
                row.querySelector('.r-chk').checked = false;
                row.classList.remove('checked-row');
                row.querySelector('.r-min').value = '';
                row.querySelector('.r-sec').value = '';
                row.querySelector('.r-c').selectedIndex = 0;
                row.querySelector('.r-s').selectedIndex = 0;
                if (row.querySelector('.r-m')) row.querySelector('.r-m').value = '';
                row.querySelector('.r-nrs').selectedIndex = 0;
                row.querySelector('.r-bg').selectedIndex = 0;
            });
        }
        function resetBrstage(btn) {
            const b = btn.closest('.patient-block');
            b.querySelectorAll('.br-ue, .br-ha, .br-le').forEach(s => s.value = '-');
        }
        function resetComps(btn) {
            const b = btn.closest('.patient-block');
            b.querySelectorAll('.compare-body .compare-row').forEach(row => {
                const chk = row.querySelector('.c-chk');
                if (chk) {
                    chk.checked = false;
                    const sideEl = row.querySelector('.c-side');
                    if (sideEl) { sideEl.value = 'lr'; toggleCompSide(sideEl); }
                    if (row.querySelector('.c-r')) row.querySelector('.c-r').value = '';
                    if (row.querySelector('.c-l')) row.querySelector('.c-l').value = '';
                    if (row.querySelector('.c-val')) row.querySelector('.c-val').value = '';
                }
            });
        }
        function resetTextarea(btn, cls) {
            const b = btn.closest('.patient-block');
            b.querySelector(cls).value = '';
        }
        function resetHbDs(btn, selCls, inputCls) {
            const b = btn.closest('.patient-block');
            const sel = b.querySelector(selCls);
            sel.value = 'ãªã—'; tgD(sel);
            b.querySelector(inputCls).value = '';
        }

        function clearAllInputs() {
            if (!confirm('ã™ã¹ã¦ã®å…¥åŠ›é …ç›®ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè¨˜æ†¶æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ï¼‰')) return;
            document.querySelectorAll('.patient-block').forEach(b => {
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                b.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = '');
                // ã‚»ãƒ¬ã‚¯ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
                b.querySelector('.p-age').selectedIndex = 0;
                b.querySelector('.p-sex').value = '';
                b.querySelector('.p-side').value = '';
                highlight(b.querySelector('.p-side'));
                b.querySelector('.p-disease').selectedIndex = 0;
                b.querySelector('.p-dis-side').value = '';
                b.querySelector('.p-h').selectedIndex = 0;
                b.querySelector('.p-m').selectedIndex = 0;
                b.querySelector('.p-hb').value = 'ãªã—'; tgD(b.querySelector('.p-hb'));
                b.querySelector('.p-ds').value = 'ãªã—'; tgD(b.querySelector('.p-ds'));
                b.querySelectorAll('.br-ue, .br-ha, .br-le').forEach(s => s.value = '-');
                // ãƒªãƒå†…å®¹ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãƒªã‚»ãƒƒãƒˆ
                b.querySelectorAll('.rehab-list-body .list-row').forEach(row => {
                    row.querySelector('.r-chk').checked = false;
                    row.classList.remove('checked-row');
                    row.querySelector('.r-min').value = '';
                    row.querySelector('.r-sec').value = '';
                    row.querySelector('.r-c').selectedIndex = 0;
                    row.querySelector('.r-s').selectedIndex = 0;
                    if (row.querySelector('.r-m')) row.querySelector('.r-m').value = '';
                    row.querySelector('.r-nrs').selectedIndex = 0;
                    row.querySelector('.r-bg').selectedIndex = 0;
                });
                // è©•ä¾¡é …ç›®ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãƒªã‚»ãƒƒãƒˆ
                b.querySelectorAll('.compare-body .compare-row').forEach(row => {
                    const chk = row.querySelector('.c-chk');
                    if (chk) {
                        chk.checked = false;
                        const sideEl = row.querySelector('.c-side');
                        if (sideEl) { sideEl.value = 'lr'; toggleCompSide(sideEl); }
                        if (row.querySelector('.c-r')) row.querySelector('.c-r').value = '';
                        if (row.querySelector('.c-l')) row.querySelector('.c-l').value = '';
                        if (row.querySelector('.c-val')) row.querySelector('.c-val').value = '';
                    }
                });
            });
            // å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚‚éè¡¨ç¤ºã«
            document.getElementById('output').style.display = 'none';
            document.getElementById('output').innerText = '';
        }

        window.onload = () => {
            loadConfig();
            document.getElementById('dateInput').valueAsDate = new Date();
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¾©å…ƒ
            if (localStorage.getItem(DB_PREFIX + 'darkMode') === '1') {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-toggle').textContent = 'â˜€ï¸';
            }
            updateDiseaseSearchOptions();
            // è‡ªå‹•ä¿å­˜ãƒ‰ãƒ©ãƒ•ãƒˆå¾©å…ƒ
            if (!loadAutoSaveDraft()) {
                addPatientBlock();
            }
            showDataStatus();
            startAutoSave();
        };

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('nav-menu');
            const menuContainer = document.querySelector('.menu-container');
            if (menu.style.display === 'block' && !menuContainer.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // === ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆæ©Ÿèƒ½ ===
        const ASSESS_FIELDS_1 = ['as1-age', 'as1-sex', 'as1-diagnosis', 'as1-comorbidity', 'as1-pastHistory', 'as1-currentHistory', 'as1-medication', 'as1-restrictions', 'as1-family', 'as1-livingEnv', 'as1-preLife', 'as1-wardLife', 'as1-basicMovement', 'as1-adl', 'as1-chiefComplaint', 'as1-otherProfPlan', 'as1-methods', 'as1-prognosis', 'as1-stg', 'as1-ltg', 'as1-treatment'];
        const ASSESS_FIELDS_2 = ['as2-healthCondition', 'as2-bodyFunction', 'as2-activityCan', 'as2-activityDo', 'as2-participation', 'as2-envPositive', 'as2-envNegative', 'as2-personalFactor', 'as2-integration'];

        function showAssessmentSheet() {
            const menu = document.getElementById('nav-menu');
            menu.style.display = 'none';
            // æ‚£è€…ãƒªã‚¹ãƒˆæ§‹ç¯‰
            const sel = document.getElementById('assess-patient');
            sel.innerHTML = '<option value="">-- æ‚£è€…ã‚’é¸æŠ --</option>';
            // ä¿å­˜æ¸ˆã¿æ‚£è€…ã‚’è¿½åŠ 
            const savedPatients = new Set();
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith(DB_PREFIX + 'full_mem_')) {
                    savedPatients.add(k.replace(DB_PREFIX + 'full_mem_', ''));
                }
                if (k.startsWith(DB_PREFIX + 'assess_')) {
                    savedPatients.add(k.replace(DB_PREFIX + 'assess_', ''));
                }
            }
            if (savedPatients.size === 0) {
                sel.innerHTML += '<option value="" disabled>é¸æŠè‚¢ãŒã‚ã‚Šã¾ã›ã‚“</option>';
            }
            const sorted = Array.from(savedPatients).sort();
            sorted.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = p;
                sel.appendChild(opt);
            });
            // æ—¥ä»˜ã‚’ä»Šæ—¥ã«
            document.getElementById('assess-date').valueAsDate = new Date();
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            clearAssessForm();
            switchAssessTab('sheet1');
            document.getElementById('assess-modal').style.display = 'block';
        }

        function switchAssessTab(tab) {
            document.getElementById('assess-sheet1').style.display = tab === 'sheet1' ? 'block' : 'none';
            document.getElementById('assess-sheet2').style.display = tab === 'sheet2' ? 'block' : 'none';
            document.getElementById('assess-tab1').classList.toggle('active', tab === 'sheet1');
            document.getElementById('assess-tab2').classList.toggle('active', tab === 'sheet2');
        }

        function clearAssessForm() {
            ASSESS_FIELDS_1.concat(ASSESS_FIELDS_2).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }

        function getAssessData() {
            const data = { sheet1: {}, sheet2: {} };
            ASSESS_FIELDS_1.forEach(id => { data.sheet1[id] = document.getElementById(id).value; });
            ASSESS_FIELDS_2.forEach(id => { data.sheet2[id] = document.getElementById(id).value; });
            return data;
        }

        function setAssessData(data) {
            if (!data) return;
            if (data.sheet1) ASSESS_FIELDS_1.forEach(id => { if (data.sheet1[id] !== undefined) document.getElementById(id).value = data.sheet1[id]; });
            if (data.sheet2) ASSESS_FIELDS_2.forEach(id => { if (data.sheet2[id] !== undefined) document.getElementById(id).value = data.sheet2[id]; });
        }

        function saveAssessment() {
            const name = document.getElementById('assess-patient').value;
            const date = document.getElementById('assess-date').value;
            if (!name) { alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if (!date) { alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const data = getAssessData();
            data.date = date;
            // æ—¢å­˜å±¥æ­´ã‚’å–å¾—
            let hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'assess_' + name)) || [];
            const idx = hist.findIndex(h => h.date === date);
            if (idx >= 0) { hist[idx] = data; } else { hist.push(data); }
            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            hist.sort((a, b) => a.date.localeCompare(b.date));
            localStorage.setItem(DB_PREFIX + 'assess_' + name, JSON.stringify(hist));
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã§é€šçŸ¥
            const bar = document.getElementById('data-status-bar');
            bar.style.background = '#d1fae5'; bar.style.color = '#065f46'; bar.style.borderTop = '2px solid #10b981';
            bar.innerHTML = `âœ… ${name} ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆï¼ˆ${date}ï¼‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ`;
            bar.style.display = 'block'; bar.style.opacity = '1';
            setTimeout(() => { bar.style.opacity = '0'; setTimeout(() => { bar.style.display = 'none'; bar.style.opacity = '1'; }, 500); }, 3000);
        }

        function loadAssessment() {
            const name = document.getElementById('assess-patient').value;
            const date = document.getElementById('assess-date').value;
            clearAssessForm();
            if (!name) return;
            const hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'assess_' + name)) || [];
            if (!hist.length) return;
            // é¸æŠæ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãƒ­ãƒ¼ãƒ‰ã€ãªã‘ã‚Œã°æœ€æ–°ã‚’ãƒ­ãƒ¼ãƒ‰
            let entry = hist.find(h => h.date === date);
            if (!entry) entry = hist[hist.length - 1];
            if (entry) {
                document.getElementById('assess-date').value = entry.date;
                setAssessData(entry);
            }
        }

        function loadAssessmentByDate() {
            const name = document.getElementById('assess-patient').value;
            const date = document.getElementById('assess-date').value;
            if (!name || !date) return;
            clearAssessForm();
            const hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'assess_' + name)) || [];
            const entry = hist.find(h => h.date === date);
            if (entry) setAssessData(entry);
        }

        function loadAssessmentDates() {
            const name = document.getElementById('assess-patient').value;
            if (!name) { alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'assess_' + name)) || [];
            if (!hist.length) { alert(name + ' ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
            const dates = hist.map(h => h.date).join('\n');
            const selected = prompt('ä¿å­˜æ¸ˆã¿ã®æ—¥ä»˜ä¸€è¦§:\n' + dates + '\n\nè¡¨ç¤ºã—ãŸã„æ—¥ä»˜ã‚’å…¥åŠ›ï¼ˆä¾‹: 2026-02-23ï¼‰:');
            if (selected) {
                const entry = hist.find(h => h.date === selected.trim());
                if (entry) {
                    document.getElementById('assess-date').value = entry.date;
                    clearAssessForm();
                    setAssessData(entry);
                } else {
                    alert('è©²å½“ã™ã‚‹æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                }
            }
        }

        function generateAssessmentNote() {
            const name = document.getElementById('assess-patient').value;
            const date = document.getElementById('assess-date').value;
            if (!name) { alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const v = id => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };

            let note = `=== ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆ ===\n`;
            note += `æ‚£è€…: ${name}  è¨˜å…¥æ—¥: ${date}\n\n`;

            // ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ… 
            note += `â”â” ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ…  â”â”\n\n`;
            note += `ã€åŸºç¤æƒ…å ±ãƒ»åŒ»å­¦çš„æƒ…å ±ã€‘\n`;
            if (v('as1-age')) note += `å¹´é½¢: ${v('as1-age')}\n`;
            if (v('as1-sex')) note += `æ€§åˆ¥: ${v('as1-sex')}\n`;
            if (v('as1-diagnosis')) note += `è¨ºæ–­å: ${v('as1-diagnosis')}\n`;
            if (v('as1-comorbidity')) note += `åˆä½µç—‡: ${v('as1-comorbidity')}\n`;
            if (v('as1-pastHistory')) note += `æ—¢å¾€æ­´: ${v('as1-pastHistory')}\n`;
            if (v('as1-currentHistory')) note += `ç¾ç—…æ­´:\n${v('as1-currentHistory')}\n`;
            if (v('as1-medication')) note += `æœè–¬çŠ¶æ³: ${v('as1-medication')}\n`;
            if (v('as1-restrictions')) note += `å®‰é™åº¦ãƒ»ç‰¹è¨˜äº‹é …: ${v('as1-restrictions')}\n`;
            note += `\n`;

            note += `ã€ç¤¾ä¼šçš„èƒŒæ™¯ãƒ»ç”Ÿæ´»æƒ…å ±ã€‘\n`;
            if (v('as1-family')) note += `å®¶æ—æ§‹æˆ: ${v('as1-family')}\n`;
            if (v('as1-livingEnv')) note += `ä½ç’°å¢ƒ: ${v('as1-livingEnv')}\n`;
            if (v('as1-preLife')) note += `å…¥é™¢å‰ã®ç”Ÿæ´»:\n${v('as1-preLife')}\n`;
            if (v('as1-wardLife')) note += `ç—…æ£Ÿã®ç”Ÿæ´»:\n${v('as1-wardLife')}\n`;
            note += `\n`;

            note += `ã€åŸºæœ¬å‹•ä½œãƒ»ADLã€‘\n`;
            if (v('as1-basicMovement')) note += `åŸºæœ¬å‹•ä½œ:\n${v('as1-basicMovement')}\n`;
            if (v('as1-adl')) note += `ç—…æ£ŸADL:\n${v('as1-adl')}\n`;
            note += `\n`;

            if (v('as1-chiefComplaint')) note += `ã€ä¸»è¨´ã€‘\n${v('as1-chiefComplaint')}\n\n`;

            note += `ã€ä»‹å…¥æ–¹é‡ãƒ»è¨ˆç”»ãƒ»ç›®æ¨™ã€‘\n`;
            if (v('as1-otherProfPlan')) note += `ä»–è·ç¨®ã®ä»‹å…¥æ–¹é‡ãƒ»ç›®æ¨™:\n${v('as1-otherProfPlan')}\n`;
            if (v('as1-methods')) note += `æ–¹æ³•: ${v('as1-methods')}\n`;
            if (v('as1-prognosis')) note += `äºˆå¾Œäºˆæ¸¬:\n${v('as1-prognosis')}\n`;
            if (v('as1-stg')) note += `çŸ­æœŸç›®æ¨™: ${v('as1-stg')}\n`;
            if (v('as1-ltg')) note += `é•·æœŸç›®æ¨™: ${v('as1-ltg')}\n`;
            if (v('as1-treatment')) note += `æ²»ç™‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ :\n${v('as1-treatment')}\n`;
            note += `\n`;

            // ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ…¡ï¼ˆICFï¼‰
            note += `â”â” ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆâ…¡ï¼ˆICFï¼‰ â”â”\n\n`;
            if (v('as2-healthCondition')) note += `ã€å¥åº·çŠ¶æ…‹ã€‘\n${v('as2-healthCondition')}\n\n`;
            if (v('as2-bodyFunction')) note += `ã€å¿ƒèº«æ©Ÿèƒ½ãƒ»èº«ä½“æ§‹é€ ã€‘\n${v('as2-bodyFunction')}\n\n`;
            if (v('as2-activityCan') || v('as2-activityDo')) {
                note += `ã€æ´»å‹•ã€‘\n`;
                if (v('as2-activityCan')) note += `ã§ãã‚‹æ´»å‹•: ${v('as2-activityCan')}\n`;
                if (v('as2-activityDo')) note += `ã—ã¦ã„ã‚‹æ´»å‹•: ${v('as2-activityDo')}\n`;
                note += `\n`;
            }
            if (v('as2-participation')) note += `ã€å‚åŠ ã€‘\n${v('as2-participation')}\n\n`;
            if (v('as2-envPositive') || v('as2-envNegative')) {
                note += `ã€ç’°å¢ƒå› å­ã€‘\n`;
                if (v('as2-envPositive')) note += `ä¿ƒé€²å› å­: ${v('as2-envPositive')}\n`;
                if (v('as2-envNegative')) note += `é˜»å®³å› å­: ${v('as2-envNegative')}\n`;
                note += `\n`;
            }
            if (v('as2-personalFactor')) note += `ã€å€‹äººå› å­ã€‘\n${v('as2-personalFactor')}\n\n`;
            if (v('as2-integration')) note += `ã€çµ±åˆã¨è§£é‡ˆã€‘\n${v('as2-integration')}\n\n`;

            // å‡ºåŠ›è¡¨ç¤º
            const outputEl = document.getElementById('assess-output');
            outputEl.innerText = note;
            outputEl.style.display = 'block';
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(note).then(() => alert('ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼')).catch(() => alert('ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼ï¼ˆæ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰'));
            } else {
                alert('ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼ï¼ˆæ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰');
            }
        }

        // === ç—‡ä¾‹æ‚£è€…ãƒˆã‚°ãƒ« ===
        function toggleCasePatient(chk) {
            const block = chk.closest('.patient-block');
            const sField = block.querySelector('.soap-s-field');
            const pField = block.querySelector('.soap-p-field');
            if (chk.checked) {
                if (sField) sField.classList.add('visible');
                if (pField) pField.classList.add('visible');
            } else {
                if (sField) sField.classList.remove('visible');
                if (pField) pField.classList.remove('visible');
            }
        }

        // === ãƒãƒ¼ãƒˆã‚³ãƒ”ãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤å¤–ï¼‰===
        function copyNoteBody() {
            const text = document.getElementById('output').innerText;
            // 1è¡Œç›®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã¨ç©ºè¡Œã‚’é™¤å¤–ã—ã¦ã‚³ãƒ”ãƒ¼
            const lines = text.split('\n');
            let startIdx = 0;
            // ã€Œç†å­¦ç™‚æ³•å®Ÿç¿’ ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆã€ã§å§‹ã¾ã‚‹è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('ç†å­¦ç™‚æ³•å®Ÿç¿’')) { startIdx = i + 1; continue; }
                if (startIdx > 0 && lines[i].trim() === '') { startIdx = i + 1; continue; }
                break;
            }
            const body = lines.slice(startIdx).join('\n');
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(body).then(() => alert('ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤å¤–ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼')).catch(() => alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            }
        }

        // === çµŒéè¨˜éŒ²ï¼ˆSOAPï¼‰æ©Ÿèƒ½ ===
        function showProgressRecord() {
            const menu = document.getElementById('nav-menu');
            menu.style.display = 'none';
            const sel = document.getElementById('soap-patient');
            sel.innerHTML = '<option value="">-- æ‚£è€…ã‚’é¸æŠ --</option>';
            const savedPatients = new Set();
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith(DB_PREFIX + 'full_mem_')) savedPatients.add(k.replace(DB_PREFIX + 'full_mem_', ''));
                if (k.startsWith(DB_PREFIX + 'soap_')) savedPatients.add(k.replace(DB_PREFIX + 'soap_', ''));
            }
            if (savedPatients.size === 0) {
                sel.innerHTML += '<option value="" disabled>é¸æŠè‚¢ãŒã‚ã‚Šã¾ã›ã‚“</option>';
            }
            Array.from(savedPatients).sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = p;
                sel.appendChild(opt);
            });
            showSOAPList();
            document.getElementById('soap-modal').style.display = 'block';
        }

        function clearSOAPForm() {
            ['soap-s', 'soap-o', 'soap-a', 'soap-p'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const out = document.getElementById('soap-output');
            if (out) out.style.display = 'none';
        }

        function showSOAPList() {
            document.getElementById('soap-list-view').style.display = 'block';
            document.getElementById('soap-input-view').style.display = 'none';
            renderSOAPHistory();
        }

        function showSOAPInput(editDate) {
            document.getElementById('soap-list-view').style.display = 'none';
            document.getElementById('soap-input-view').style.display = 'block';
            clearSOAPForm();
            if (editDate) {
                // æ—¢å­˜è¨˜éŒ²ã‚’ç·¨é›†
                document.getElementById('soap-date').value = editDate;
                const name = document.getElementById('soap-patient').value;
                const hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'soap_' + name)) || [];
                const entry = hist.find(h => h.date === editDate);
                if (entry) {
                    document.getElementById('soap-s').value = entry.s || '';
                    document.getElementById('soap-o').value = entry.o || '';
                    document.getElementById('soap-a').value = entry.a || '';
                    document.getElementById('soap-p').value = entry.p || '';
                }
            } else {
                // æ–°è¦å…¥åŠ›
                document.getElementById('soap-date').valueAsDate = new Date();
            }
        }

        function onSOAPPatientChange() {
            showSOAPList();
        }

        function renderSOAPHistory() {
            const name = document.getElementById('soap-patient').value;
            const container = document.getElementById('soap-history-list');
            const exportBtn = document.getElementById('soap-export-all-btn');
            const allOut = document.getElementById('soap-all-output');
            exportBtn.style.display = 'none';
            allOut.style.display = 'none';
            if (!name) {
                container.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:30px 0;">æ‚£è€…ã‚’é¸æŠã™ã‚‹ã¨è¨˜éŒ²ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                return;
            }
            const hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'soap_' + name)) || [];
            if (!hist.length) {
                container.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:30px 0;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œâœï¸ æ–°è¦å…¥åŠ›ã€ã‹ã‚‰è¨˜éŒ²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }
            // æ–°ã—ã„æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sorted = [...hist].sort((a, b) => b.date.localeCompare(a.date));
            let html = '';
            sorted.forEach(entry => {
                const truncate = (str, len) => str && str.length > len ? str.substring(0, len) + 'â€¦' : (str || '');
                html += `<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-weight:bold;color:var(--primary);font-size:0.95rem;">ğŸ“… ${entry.date}</span>
                        <div style="display:flex;gap:4px;">
                            <button onclick="showSOAPInput('${entry.date}')" style="padding:4px 10px;background:var(--secondary);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.75rem;">âœï¸ ç·¨é›†</button>
                            <button onclick="deleteSOAPEntry('${entry.date}')" style="padding:4px 10px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.75rem;">ğŸ—‘</button>
                        </div>
                    </div>`;
                if (entry.s) html += `<div style="margin-bottom:4px;"><span style="display:inline-block;background:#3b82f6;color:white;padding:1px 6px;border-radius:3px;font-size:0.7rem;font-weight:bold;margin-right:4px;">S</span><span style="font-size:0.82rem;">${truncate(entry.s, 120)}</span></div>`;
                if (entry.o) html += `<div style="margin-bottom:4px;"><span style="display:inline-block;background:#10b981;color:white;padding:1px 6px;border-radius:3px;font-size:0.7rem;font-weight:bold;margin-right:4px;">O</span><span style="font-size:0.82rem;">${truncate(entry.o, 120)}</span></div>`;
                if (entry.a) html += `<div style="margin-bottom:4px;"><span style="display:inline-block;background:#f59e0b;color:white;padding:1px 6px;border-radius:3px;font-size:0.7rem;font-weight:bold;margin-right:4px;">A</span><span style="font-size:0.82rem;">${truncate(entry.a, 120)}</span></div>`;
                if (entry.p) html += `<div style="margin-bottom:4px;"><span style="display:inline-block;background:#8b5cf6;color:white;padding:1px 6px;border-radius:3px;font-size:0.7rem;font-weight:bold;margin-right:4px;">P</span><span style="font-size:0.82rem;">${truncate(entry.p, 120)}</span></div>`;
                html += `</div>`;
            });
            container.innerHTML = html;
            exportBtn.style.display = 'block';
        }

        function deleteSOAPEntry(date) {
            const name = document.getElementById('soap-patient').value;
            if (!confirm(`${date} ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            let hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'soap_' + name)) || [];
            hist = hist.filter(h => h.date !== date);
            localStorage.setItem(DB_PREFIX + 'soap_' + name, JSON.stringify(hist));
            renderSOAPHistory();
        }

        function exportAllSOAP() {
            const name = document.getElementById('soap-patient').value;
            if (!name) { alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'soap_' + name)) || [];
            if (!hist.length) { alert('è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
            const sorted = [...hist].sort((a, b) => a.date.localeCompare(b.date));
            let note = `=== ${name} çµŒéè¨˜éŒ²ï¼ˆSOAPï¼‰å…¨è¨˜éŒ² ===\n\n`;
            sorted.forEach(entry => {
                note += `â”â” ${entry.date} â”â”\n`;
                if (entry.s) note += `ã€Sï¼šä¸»è¦³çš„æƒ…å ±ã€‘\n${entry.s}\n`;
                if (entry.o) note += `ã€Oï¼šå®¢è¦³çš„æƒ…å ±ã€‘\n${entry.o}\n`;
                if (entry.a) note += `ã€Aï¼šã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã€‘\n${entry.a}\n`;
                if (entry.p) note += `ã€Pï¼šè¨ˆç”»ã€‘\n${entry.p}\n`;
                note += `\n`;
            });
            const outputEl = document.getElementById('soap-all-output');
            outputEl.innerText = note;
            outputEl.style.display = 'block';
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(note).then(() => alert(`${sorted.length}ä»¶ã®çµŒéè¨˜éŒ²ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`)).catch(() => alert('å‡ºåŠ›ã—ã¾ã—ãŸï¼ˆæ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰'));
            } else {
                alert('å‡ºåŠ›ã—ã¾ã—ãŸï¼ˆæ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰');
            }
        }

        function saveSOAP() {
            const name = document.getElementById('soap-patient').value;
            const date = document.getElementById('soap-date').value;
            if (!name) { alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if (!date) { alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const data = {
                date,
                s: document.getElementById('soap-s').value,
                o: document.getElementById('soap-o').value,
                a: document.getElementById('soap-a').value,
                p: document.getElementById('soap-p').value
            };
            let hist = JSON.parse(localStorage.getItem(DB_PREFIX + 'soap_' + name)) || [];
            const idx = hist.findIndex(h => h.date === date);
            if (idx >= 0) { hist[idx] = data; } else { hist.push(data); }
            hist.sort((a, b) => a.date.localeCompare(b.date));
            localStorage.setItem(DB_PREFIX + 'soap_' + name, JSON.stringify(hist));
            const bar = document.getElementById('data-status-bar');
            bar.style.background = '#d1fae5'; bar.style.color = '#065f46'; bar.style.borderTop = '2px solid #10b981';
            bar.innerHTML = `âœ… ${name} ã®çµŒéè¨˜éŒ²ï¼ˆ${date}ï¼‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ`;
            bar.style.display = 'block'; bar.style.opacity = '1';
            setTimeout(() => { bar.style.opacity = '0'; setTimeout(() => { bar.style.display = 'none'; bar.style.opacity = '1'; }, 500); }, 3000);
            // ä¿å­˜å¾Œã«ä¸€è¦§ã«æˆ»ã‚‹
            showSOAPList();
        }

        function generateSOAPNote() {
            const name = document.getElementById('soap-patient').value;
            const date = document.getElementById('soap-date').value;
            if (!name) { alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const s = document.getElementById('soap-s').value.trim();
            const o = document.getElementById('soap-o').value.trim();
            const a = document.getElementById('soap-a').value.trim();
            const p = document.getElementById('soap-p').value.trim();

            let note = `=== çµŒéè¨˜éŒ²ï¼ˆSOAPï¼‰ ===\n`;
            note += `æ‚£è€…: ${name}  è¨˜å…¥æ—¥: ${date}\n\n`;
            if (s) note += `ã€Sï¼šä¸»è¦³çš„æƒ…å ±ã€‘\n${s}\n\n`;
            if (o) note += `ã€Oï¼šå®¢è¦³çš„æƒ…å ±ã€‘\n${o}\n\n`;
            if (a) note += `ã€Aï¼šã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã€‘\n${a}\n\n`;
            if (p) note += `ã€Pï¼šè¨ˆç”»ã€‘\n${p}\n\n`;

            const outputEl = document.getElementById('soap-output');
            outputEl.innerText = note;
            outputEl.style.display = 'block';
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(note).then(() => alert('çµŒéè¨˜éŒ²ã‚’å‡ºåŠ›ã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼')).catch(() => alert('çµŒéè¨˜éŒ²ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼'));
            } else {
                alert('çµŒéè¨˜éŒ²ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼');
            }
        }

        // Enter/æ”¹è¡Œã‚­ãƒ¼ã§æ¬¡ã®å…¥åŠ›æ¬„ã«ç§»å‹•
        document.addEventListener('keydown', (e) => {
            const el = e.target;
            // textareaå†…ã§ã¯Enterã§æ”¹è¡Œã‚’è¨±å¯ï¼ˆç§»å‹•ã—ãªã„ï¼‰
            if (el.tagName === 'TEXTAREA') return;
            // input[type=text] ã¾ãŸã¯ select ã§ Enter ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
            if (e.key === 'Enter' && (el.tagName === 'INPUT' || el.tagName === 'SELECT')) {
                e.preventDefault();
                // åŒã˜ patient-block å†…ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ãªè¦ç´ ã‚’å–å¾—
                const block = el.closest('.patient-block');
                if (!block) return;
                const focusable = Array.from(block.querySelectorAll('input[type="text"]:not([style*="display:none"]):not([style*="display: none"]), select:not([style*="display:none"]):not([style*="display: none"]), textarea'));
                const idx = focusable.indexOf(el);
                if (idx >= 0 && idx < focusable.length - 1) {
                    focusable[idx + 1].focus();
                }
            }
        });
    </script>
    <script>
        // Service Worker ç™»éŒ²ï¼ˆPWA ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>

</html>